# 4 Системный дизайн

## 4.1 Контекстная диаграмма

Контекстная диаграмма (C4) интеграционного решения для автоматизации email-коммуникаций.   
![](/images/system_design/ContextDiagram.png)
Более детально диаграмму можно рассмотреть по [ссылке](https://drive.google.com/file/d/16MWB8mrscRLXuB0DsNfqFWIAJLX2JQrF/view?usp=drive_link).

### 4.1.1 Описание участвующих компонентов и их связей

Главная система \- Платформа "Давайте соберемся" базируется на следующих технических решениях:

1. Bitrix (1С-Битрикс: Управление сайтом) \- центральный узел для операций пользователей, благотворителей и администраторов.  
2. Сервис интеграции \- прослойка между платформой и внешними сервисами, реализует бизнес-логику, оркестрацию, retry, хранение состояния и логику событий.

Внешние сервисы:

1. Unisender Go \- сервис управления email-рассылками, интеграция через API:  
   1. отправка транзакционных писем,   
   2. управление контактами,   
   3. отслеживание статистики.  
2. Unisender \- сервис управления email-рассылками конкретного типа, интеграция через API:  
   1. рассылка на электронную почту при пожертвовании,  
   2. рассылка на электронную почту при регистрации на Платформе.  
3. CloudPayment \- сервис обработки платежей, взаимодействие через API и realtime callback.  
4. MixPlat \- сервис обработки платежей, подключение через API/realtime callback \- выделен пунктиром по причине, указанной ниже.

Необходимо отметить, что сервис MixPlat в дальнейшем было принято не реализовывать в рамках данной концепции, поскольку нет явной декларации о необходимости использования взаимозаменяемых провайдеров оплаты. Ввиду этого выбор в рамках данного документа сделан в пользу сервиса CloudPayments. Это обосновано более ясной документацией API и декларациями заказчиков в рамках задаваемых им вопросов. При дальнейшей реализации интеграции командой разработки, выбор может быть своевременно откорректирован.

### 4.1.2 Типы соединений между сущностями

| От кого | К кому | Тип соединения | Назначение/Описание |
| :---- | :---- | :---- | :---- |
| Bitrix | Сервис интеграции | API/DB event | отправка триггеров, заявок на письма |
| Сервис интеграции | Unisender Go | API | email-рассылки |
| Сервис интеграции | Unisender | API | рассылка по усмотрению Фонда |
| Сервис интеграции | CloudPayment | API/webhook/realtime callback | обработка рекуррентных платежей |
| Сервис интеграции | MixPlat/CloudPayment | API/realtime callback | обработка платежей |
| Bitrix | Благотворитель | Web-интерфейс (UI) | личный кабинет, платежи |
| Bitrix | Пользователь | Web-интерфейс (UI) | создание/отправка событий |
| Bitrix | Администратор | Web-интерфейс (UI) | модерация событий, управление платформой |

Сервис интеграции соединяет Платформу “Давайте соберемся” с внешними сервисами, обеспечивая реализацию бизнес-правил и ФТ/НФТ. Взаимодействие пользовательских ролей с Платформой осуществляется через пользовательский интерфейс, что на контекстной диаграмме решено не указывать. Также на контекстной диаграмме продемонстрировано хранилище данных (реляционная СУБД) для понимания связанности размещаемых в ней данных с другими сущностями.

## 4.2 Диаграмма контейнеров

![](/images/system_design/ContainerDiagram.png)  
Более детально диаграмму можно рассмотреть по [ссылке](https://drive.google.com/file/d/1WUIPp1JGinolwSVTujKpYT8hsV8T0BzT/view?usp=sharing).

### 4.2.1 Обоснование выбора по взаимодействию между сервисами Платформы

Взаимодействие между 1С-Битрикс и Сервисом интеграции по REST рекомендуется реализовать как REST API с внутренней асинхронной очередью сообщений в Сервисе интеграций. Выбор в данную сторону, в отличие от прямого использования брокера сообщений типа Kafka обоснован следующими требованиями:

* НФТ-1.1: триггер → API запрос ≤ 5 сек,  
* НФТ-1.2: отправка благодарности ≤ 2 минуты,  
* НФТ-1.3: до 1000 триггеров/час (26.6 запросов/сек пиковая нагрузка),  
* НФТ-2.3: zero data loss при сбоях,  
* НФТ-2.4: механизм повторных попыток,  
* НФТ-2.5: устойчивость к сбоям API (очередь и повторы),  
* НФТ-2.6: ≤ 0.5% ошибок доставки в год,  
* НФТ-2.7: 99.5% успешных отправок,  
* НФТ-2.8: отказоустойчивость \- продолжить работу при сбое одного модуля,  
* НФТ-2.9: масштабирование до 5000 триггеров/час,  
* БО-1: использование Яндекс.Облако для дальнейшей эксплуатации,  
* БО-2: код Битрикса не модифицируем.

Выбор обоснован CAP-теоремой в рамках приоритета **Согласованности** (Consistency) и **Доступности** (Availability). Непосредственно в самом Сервисе интеграции возможно применять RabbitMQ/Redis (будем далее указывать RabbitMQ) с асинхронной очередью, которые подходят для указанного в требованиях число сообщений и достаточно для начального этапа разработки. 

### 4.2.2 Описание участвующих компонентов и связи между ними

Описание компонентов в целом достаточно совпадает с тем, что указано на контейнерной диаграммой. Также показано репликация данных СУБД Сервиса интеграции (PostgreSQL) для выполнения требований по масштабированию и надёжности. Логика работы Сервиса интеграции строится на взаимодействии Веб-сервиса и Воркеров через асинхронную очередь RabbitMQ: 

* Веб-сервер публикует сообщение в очередь через AMQP через RabbitMQ,  
* Веб-сервер инициализирует задачи в воркер через логическое взаимодействие RabbitMQ,  
* RabbitMQ отвечает за получение асинхронных сообщений из очереди для воркера.

Непосредственно с внешними сервисами по REST API взаимодействует воркер.   

У Сервиса интеграции собственная СУБД (реляционная, типа PostgreSQL), к которой обращаются и Worker, и Веб-сервер.   

Также необходимо отметить, что у Сервиса интеграции отдельная Админ-панель, визуализация которой [представлена в соответствующем разделе](/docs/04_ui/README.md). Именно к ней может обращаться Администратор Платформы для выполнения ряда требований (например, модерации Событий). Важно отметить, что в данной концепции Админ-панель не является частью 1С-Битрикс, а работает только с Сервисом интеграции. Тем самым Администратор посредством Админ-панели обращается к СУБД Сервиса интеграции посредством Веб-сервиса.