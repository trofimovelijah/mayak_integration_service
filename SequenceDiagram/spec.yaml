openapi: 3.0.0
servers:
  - url: 'https://virtserver.swaggerhub.com/aosu/mayak_integration/1.0.0'
    description: SwaggerHub API Auto Mocking
info:
  description: |
    Спецификация интеграционного сервиса для Благотворительного фонда «Дом с маякам».
    
    ### Важные замечания
    - Все эндпоинты требуют аутентификацию через заголовок `Authorization: Bearer <token>`
    - Для всех операций записи (POST, PUT, DELETE) требуется заголовок `Idempotency-Key` с уникальным UUID
    - Повторные запросы с тем же Idempotency-Key вернут результат первоначального запроса без повторного выполнения операции
    - Для обработки ошибок 429 используйте заголовок `X-RateLimit-Reset`, указывающий время до сброса лимита
  version: 1.0.0
  title: API интеграционного сервиса фонда «Дом с маяком»
  contact:
    email: payment@mayak.help
    url: 'https://join.mayak.help'
    name: по вопросам пожертвований
  termsOfService: 'https://join.mayak.help/assets/Politika_obespecheniya_bezopasnosti_PD_k_prikazu_74_ot_29_11_24.pdf'
tags:
  - name: Почтовые уведомления и рассылки
    description: 'Операции, связанные с отправкой писем, массовых рассылок, уведомлений, webhooks Unisender и UnisenderGo.'
  - name: События и модерация
    description: 'Создание, модерация, статусы и получение событий платформы.'
  - name: Платёжные операции и подписки
    description: 'Пожертвования, рекуррентные платежи, webhooks CloudPayments, операции с подписками.'
  - name: Администрирование
    description: 'Операции с шаблонами писем со стороны Администратора'
  - name: Статистика и мониторинг
    description: 'Операции с логами, мониторингом и статистикой.'
paths:

    # ============================================
    # Почтовые уведомления и рассылки
    # ============================================
  /email/send:
    post:
      tags:
        - Почтовые уведомления и рассылки
      summary: Отправка письма (уведомления)
      operationId: sendEmailUniversal
      description: |
        Отправка письма по различным бизнес-сценариям. Используйте различные наборы параметров в зависимости от типа письма.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EmailSendRequest'
      responses:
        '200':
          description: Письмо успешно отправлено
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: ['sent', 'queued']
                    description: |
                      Статус отправки:
                      - `sent` — письмо немедленно отправлено
                      - `queued` — письмо помещено в очередь (при высокой нагрузке)
                  email_id:
                    type: string
                    format: uuid
                    description: Уникальный идентификатор письма в системе интеграции
                  message_id:
                    type: string
                    description: Идентификатор письма во внешней системе (UnisenderGo/Unisender)
                  sent_at:
                    type: string
                    format: date-time
                    description: Timestamp отправки (ISO 8601)
                  retry_count:
                    type: integer
                    description: Количество повторных попыток (0 если отправлено с первой попытки)
                    minimum: 0
                    maximum: 3
                required:
                  - status
                  - email_id
                  - sent_at
              example:
                status: 'sent'
                email_id: 'a1b2c3d4-5678-90ab-cdef-1234567890ab'
                message_id: 'msg_9b11d0c3c08a44de'
                sent_at: '2025-11-13T15:27:45.123Z'
                retry_count: 0
        
        '400':
          description: Некорректные параметры запроса (отсутствуют обязательные поля)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '401':
          description: Отсутствует или недействителен JWT токен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '422':
          description: |
            Ошибка валидации данных.

            Email не соответствует RFC 5322

            Дедупликация — письмо уже отправлялось в течение 24 часов
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
              examples:
                invalidEmail:
                  summary: Невалидный email адрес
                  value:
                    error_code: 'INVALID_EMAIL'
                    error_message: 'Email адрес не соответствует RFC 5322'
                    email: 'invalid@email@example.com'
                    timestamp: '2025-11-13T15:27:45.123Z'
                
                duplicateEmail:
                  summary: Письмо уже отправлялось (дедупликация)
                  value:
                    error_code: 'DUPLICATE_EMAIL_24H'
                    error_message: 'Письмо с template_id=FT-022 уже было отправлено на адрес i***v@example.com менее 24 часов назад'
                    template_id: 'FT-022'
                    last_sent_at: '2025-11-13T10:15:30.456Z'
                    timestamp: '2025-11-13T15:27:45.123Z'
        
        '429':
          description: |
            Превышен лимит запросов (rate limiting).
            Обработка лимитов внешних API.
          headers:
            X-RateLimit-Reset:
              schema:
                type: integer
              description: Unix timestamp сброса лимита
              example: 1699884465
            Retry-After:
              schema:
                type: integer
              description: Секунды до следующей попытки
              example: 120
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitErrorResponse'
        
        '500':
          description: |
            Ошибка сервера или недоступность внешнего сервиса.
            Применяется логика повторов с экспоненциальной задержкой.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerErrorResponse'

  /email/subscribers:
    post:
      tags:
        - Почтовые уведомления и рассылки
      summary: Добавление email в лист рассылки Unisender
      operationId: addSubscriber
      description: |
        Добавление email пользователя в список рассылки 
        для дальнейших действий по усмотрению Платформы.

      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubscriberRequest'

      responses:
        '200':
          description: Email успешно добавлен в список рассылки
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: ['added', 'already_exists']
                    description: |
                      Статус добавления:
                      - `added` — email успешно добавлен
                      - `already_exists` — email уже был в списке
                  subscriber_id:
                    type: string
                    format: uuid
                    description: Уникальный ID подписчика в системе
                  unisender_id:
                    type: string
                    description: ID подписчика в системе Unisender
                  email:
                    type: string
                    format: email
                    description: Email адрес (частично скрыт для безопасности)
                required:
                  - status
                  - subscriber_id
              example:
                status: 'added'
                subscriber_id: 'b2c3d4e5-6789-01ab-cdef-234567890abc'
                unisender_id: '12345678'
                email: 'i***v@example.com'
        
        '400':
          description: Некорректные параметры запроса
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '422':
          description: Ошибка валидации email
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        
        '429':
          description: Превышен лимит запросов
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitErrorResponse'
        
        '500':
          description: Ошибка при взаимодействии с Unisender API
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerErrorResponse'

  # Webhook UnisenderGo (пример: обработка статуса доставки)
  /webhooks/unisendergo/delivery:
    post:
      tags:
        - Почтовые уведомления и рассылки
      operationId: unisendergoDeliveryWebhook
      summary: Webhook статуса доставки от UnisenderGo
      description: |
        Обработка webhook уведомлений от UnisenderGo о статусе доставки писем.
        
        **Возможные события:**
        - `delivered` — письмо доставлено
        - `opened` — письмо открыто
        - `clicked` — клик по ссылке в письме
        - `bounced` — письмо вернулось (hard/soft bounce)
        - `unsubscribed` — отписка от рассылки
        
        **Безопасность:** Webhook подписан HMAC SHA-256 в заголовке `X-Unisender-Signature`
      
      parameters:
        - in: header
          name: X-Unisender-Signature
          required: true
          schema:
            type: string
          description: HMAC SHA-256 подпись тела запроса
      
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UnisenderGoWebhook'
      
      responses:
        '200':
          description: Webhook успешно обработан
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: 'received'
        
        '401':
          description: Неверная подпись webhook
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    # ============================================
    # События
    # ============================================

  /events:
    get:
      tags:
        - События и модерация
      summary: Получение списка Событий
      operationId: moderationListEvent
      description: |
        Возвращает список Событий с возможностью фильтрации по статусу.
      parameters:
        - in: query
          name: status
          description: |
            Статус события для фильтрации. Возможные значения:
              - 'pending_moderation' — на модерации
              - 'published' — опубликовано
              - 'rejected' — отклонено
          required: true
          schema:
            type: string
            enum:
              - pending_moderation
              - published
              - rejected
          example: pending_moderation
        - in: query
          name: page
          description: Номер страницы для постраничной навигации.
          required: false
          schema:
            type: integer
            minimum: 1
          example: 1
        - in: query
          name: limit
          description: Количество Событий на странице (максимум 100)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          example: 20

      responses:
        '200':
          description: Список Событий успешно получен
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                    description: Общее количество Событий по фильтру
                  page:
                    type: integer
                  limit:
                    type: integer
                  total_pages:
                    type: integer
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/EventListItem'
              example:
                total: 42
                page: 1
                limit: 20
                total_pages: 3
                events:
                  - event_id: 'e995f12b-abcd-4c2d-b174-bd622174807f'
                    event_name: 'День рождения Маши'
                    event_creator_email: 'm***a@example.com'
                    created_at: '2025-11-10T14:30:00Z'
                    status: 'pending_moderation'
                    target_amount: 50000
                    images_count: 5
        
        '400':
          description: Некорректные параметры запроса
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '401':
          description: Отсутствует или недействителен JWT токен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '403':
          description: Недостаточно прав (требуется роль Администратора)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /events/{event_id}:
    get:
      tags:
        - События и модерация
      summary: Получение деталей События
      operationId: getEventDetails
      description: |
        Возвращает полную информацию о События для принятия решения по модерации.

        Пример полного объекта Event:
        
        Все поля объекта содержат детальную информацию для модератора (администратора), необходимую для принятия решения об одобрении или отклонении События:
        - Идентификаторы (event_id, admin_id)
        - Текстовые данные (event_name, event_description)
        - Финансовые параметры (target_amount, current_amount, donors_count)
        - Временные диапазоны (event_date_from, event_date_to)
        - Статусы и метаданные (status, created_at, moderation_notes)
        - Информация о создателе (event_creator_name, event_creator_email)
        - Мультимедийные данные (images_count, image_urls)
      parameters:
        - in: path
          name: event_id
          required: true
          schema:
            type: string

      responses:
        '200':
          description: Детали События успешно получены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventDetails'
        
        '401':
          description: Отсутствует или недействителен JWT токен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '403':
          description: Недостаточно прав
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '404':
          description: Событие не найдено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /events/{event_id}/approve:
    post:
      tags:
        - События и модерация
      summary: Одобрение События
      operationId: approveEvent
      description: |
        Одобряет событие по итогам модерации Администратором и переводит его в статус "published".
        Отправляет уведомление создателю События.
      parameters:
        - in: path
          name: event_id
          required: true
          description: Идентификатор события для одобрения
          schema:
            type: string
            format: uuid
      requestBody:
        description: Данные для одобрения события администратором
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EventApproveRequest'

      responses:
        '200':
          description: Событие успешно одобрено
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: 'approved'
                  event_id:
                    type: string
                    format: uuid
                  new_status:
                    type: string
                    example: 'published'
                  approved_at:
                    type: string
                    format: date-time
                  approved_by:
                    type: string
                    format: uuid
                    description: ID администратора
                  notification_sent:
                    type: boolean
                    description: Отправлено ли письмо создателю
                  email_id:
                    type: string
                    format: uuid
                    description: ID отправленного письма
              example:
                status: 'approved'
                event_id: 'e995f12b-abcd-4c2d-b174-bd622174807f'
                new_status: 'published'
                approved_at: '2025-11-13T15:30:00Z'
                approved_by: '321efdce-174a-46eb-849c-c2ffbb1c8d60'
                notification_sent: true
                email_id: 'g7h8i9j0-1234-5abc-def6-7890abcdef12'
        
        '400':
          description: Некорректные параметры
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '401':
          description: Отсутствует или недействителен JWT токен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '403':
          description: Недостаточно прав (требуется роль admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '404':
          description: Событие не найдено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '409':
          description: Конфликт статуса — Событие уже одобрено или отклонено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /events/{event_id}/reject:
    post:
      tags:
        - События и модерация
      summary: Отклонение События
      operationId: rejectEvent
      description: |
        Отклоняет событие по итогам модерации Администратором и переводит его в статус "rejected".
        Отправляет уведомление создателю События с вердикто отклонения от Администратора.
      parameters:
        - in: path
          name: event_id
          required: true
          description: Идентификатор события для отклонения
          schema:
            type: string
            format: uuid
      requestBody:
        description: Данные для отклонения события администратором
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EventRejectRequest'

      responses:
        '200':
          description: Событие успешно отклонено
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: 'rejected'
                  event_id:
                    type: string
                    format: uuid
                  new_status:
                    type: string
                    example: 'rejected'
                  rejected_at:
                    type: string
                    format: date-time
                  rejected_by:
                    type: string
                    format: uuid
                  rejection_reason:
                    type: string
                  notification_sent:
                    type: boolean
                  email_id:
                    type: string
                    format: uuid
              example:
                status: 'rejected'
                event_id: 'e995f12b-abcd-4c2d-b174-bd622174807f'
                new_status: 'rejected'
                rejected_at: '2025-11-13T15:30:00Z'
                rejected_by: '321efdce-174a-46eb-849c-c2ffbb1c8d60'
                rejection_reason: 'В описании События отсутствует информация о целевом использовании средств'
                notification_sent: true
                email_id: 'h8i9j0k1-2345-6bcd-ef78-90abcdef1234'
        
        '400':
          description: Некорректные параметры
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '401':
          description: Отсутствует или недействителен JWT токен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '403':
          description: Недостаточно прав
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '404':
          description: Событие не найдено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '409':
          description: Конфликт статуса
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    # ============================================
    # Платёжные операции и подписки
    # ============================================
  /payments:
    post:
      tags:
        - Платёжные операции и подписки
      operationId: initiatePayment
      summary: Инициирование платежа
      description: |
        Инициирует разовый платеж (пожертвование) через платежную систему CloudPayments.
        
        - Персонализация по сумме пожертвования
        - Пожертвования >= 50000₽ требуют дополнительных проверок
      
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentRequest'
      
      responses:
        '200':
          description: Платеж успешно инициирован
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: ['initiated', 'pending_3ds']
                    description: |
                      Статус платежа:
                      - `initiated` — платеж инициирован
                      - `pending_3ds` — требуется 3D-Secure
                  payment_id:
                    type: string
                    description: Внутренний ID платежа
                  transaction_id:
                    type: string
                    description: ID транзакции в CloudPayments
                  payment_url:
                    type: string
                    format: uri
                    description: URL для завершения платежа (если требуется 3D-Secure)
                  amount:
                    type: number
                    format: float
                  currency:
                    type: string
                  is_first_donation:
                    type: boolean
                    description: Первое ли это пожертвование от данного благотворителя
                  requires_additional_verification:
                    type: boolean
                    description: Требуется ли дополнительная проверка
              example:
                status: 'initiated'
                payment_id: 'pay_1a2b3c4d5e6f7890'
                transaction_id: '12345678'
                amount: 5000.00
                currency: 'RUB'
                is_first_donation: true
                requires_additional_verification: false
        
        '400':
          description: Некорректные параметры
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '422':
          description: Ошибка валидации платежа
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        
        '429':
          description: Превышен лимит запросов
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitErrorResponse'
        
        '500':
          description: Ошибка при создании платежа
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerErrorResponse'

  /subscriptions:
    post:
      tags:
        - Платёжные операции и подписки
      operationId: createSubscription
      summary: Создание подписки на рекуррентные платежи
      description: |
        Создает подписку на регулярные (рекуррентные) пожертвования.
        
        **Жизненный цикл:**
        1. Валидация email и суммы
        2. Создание подписки в CloudPayments
        3. Отправка письма с деталями подписки
        4. Если agree_newsletter=true — добавление email в рассылку
      
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubscriptionRequest'
      
      responses:
        '200':
          description: Подписка успешно создана
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: 'active'
                  subscription_id:
                    type: string
                    description: Внутренний ID подписки
                  cloudpayments_subscription_id:
                    type: string
                    description: ID подписки в CloudPayments
                  amount:
                    type: number
                    format: float
                    description: Сумма платежа в рублях (для хранения, не в копейках)
                  frequency:
                    type: string
                    enum: ['monthly', 'quarterly', 'annually']
                    description: Периодичность списаний
                  next_charge_date:
                    type: string
                    format: date
                    description: Дата следующего списания
                  notification_sent:
                    type: boolean
                    description: Отправлено ли письмо (ФТ-009)
                  email_id:
                    type: string
                    format: uuid
                  manage_url:
                    type: string
                    format: uri
                    description: URL для управления подпиской
              example:
                status: 'active'
                subscription_id: 'sub_3c4d5e6f7890abcd'
                cloudpayments_subscription_id: '87654321'
                amount: 1000.00
                frequency: 'monthly'
                next_charge_date: '2025-12-01'
                notification_sent: true
                email_id: 'i9j0k1l2-3456-7cde-f890-1abcdef23456'
                manage_url: 'https://join.mayak.help/manage-subscription/sub_3c4d5e6f7890abcd'
        
        '400':
          description: Некорректные параметры
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '422':
          description: Ошибка валидации подписки
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        
        '429':
          description: Превышен лимит запросов
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitErrorResponse'
        
        '500':
          description: Ошибка при создании подписки
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerErrorResponse'

  /subscriptions/{subscription_id}/cancel:
    delete:
      tags:
        - Платёжные операции и подписки
      operationId: cancelSubscription
      summary: Отмена подписки на рекуррентные платежи
      description: |
        Отмена подписки на рекуррентные платежи по инициативе Благотворителя.
        Отправляет прощальное письмо.
      
      parameters:
        - in: path
          name: subscription_id
          required: true
          schema:
            type: string
          description: Идентификатор подписки для отмены
        
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubscriptionCancelRequest'
      responses:
        '200':
          description: Подписка успешно отменена
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: 'cancelled'
                  subscription_id:
                    type: string
                  cancelled_at:
                    type: string
                    format: date-time
                  notification_sent:
                    type: boolean
                  email_id:
                    type: string
                    format: uuid
                  last_charge_date:
                    type: string
                    format: date
                    description: Дата последнего успешного списания
                  total_donations:
                    type: number
                    format: float
                    description: Общая сумма пожертвований по подписке
                  donations_count:
                    type: integer
                    description: Количество успешных списаний
              example:
                status: 'cancelled'
                subscription_id: 'sub_3c4d5e6f7890abcd'
                cancelled_at: '2025-11-13T15:30:00Z'
                notification_sent: true
                email_id: 'j0k1l2m3-4567-8def-9012-3bcdef456789'
                last_charge_date: '2025-11-01'
                total_donations: 12000.00
                donations_count: 12
        
        '400':
          description: Некорректные параметры
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '404':
          description: Подписка не найдена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '409':
          description: Подписка уже отменена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '500':
          description: Ошибка при отмене подписки
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerErrorResponse'

  /webhooks/cloudpayments/pay:
    post:
      tags:
        - Платёжные операции и подписки
      operationId: cloudpaymentsPaymentSuccess
      summary: Webhook успешного платежа от CloudPayments
      description: |
        Обработка webhook уведомления о успешном платеже от CloudPayments.
        Отправляет письмо благодарности Благотворителю.
      
      parameters:
        - in: header
          name: Content-HMAC
          required: true
          schema:
            type: string
          description: HMAC SHA-256 подпись для верификации
      
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CloudPaymentWebhook'
      
      responses:
        '200':
          description: Webhook успешно обработан
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 0
                    description: Код успеха (CloudPayments требует code=0)

  /webhooks/cloudpayments/fail:
    post:
      tags:
        - Платёжные операции и подписки
      operationId: cloudpaymentsPaymentFailed
      summary: Webhook неудачного платежа от CloudPayments
      description: |
        Обработка webhook уведомления об ошибке платежа от CloudPayments.
        Отправляет письмо с информацией об ошибке и ссылкой для повтора.
      
      parameters:
        - in: header
          name: Content-HMAC
          required: true
          schema:
            type: string
      
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CloudPaymentFailWebhook'
      
      responses:
        '200':
          description: Webhook успешно обработан
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 0

  /webhooks/cloudpayments/subscription:
    post:
      tags:
        - Платёжные операции и подписки
      operationId: cloudpaymentsSubscriptionCharge
      summary: Webhook ежемесячного списания по подписке
      description: |
        Обработка webhook от CloudPayments о регулярном списании по подписке.
      
      parameters:
        - in: header
          name: Content-HMAC
          required: true
          schema:
            type: string
      
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CloudPaymentSubscriptionWebhook'
      
      responses:
        '200':
          description: Webhook успешно обработан
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 0

  # Администрирование и мониторинг
    # ============================================
    # Администрирование
    # ============================================
  /templates:
    get:
      tags:
        - Администрирование
      operationId: getTemplatesList
      summary: Получение списка шаблонов писем
      description: Возвращает список всех шаблонов писем для редактирования в админ-панели
      
      parameters:
        - in: query
          name: page
          required: false
          schema:
            type: integer
            default: 1
            minimum: 1
          description: Номер страницы
        
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
          description: Количество элементов на странице
      
      responses:
        '200':
          description: Список шаблонов получен
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
                  templates:
                    type: array
                    items:
                      $ref: '#/components/schemas/TemplateListItem'

  /templates/{template_id}:
    get:
      tags:
        - Администрирование
      operationId: getTemplateDetails
      summary: Получение деталей шаблона письма
      description: |
        Возвращает полную информацию о шаблоне письма для редактирования.
        
        Содержит все параметры шаблона, необходимые для редактирования:
        - Идентификатор (template_id)
        - Метаинформация (subject, description, created_at, updated_at)
        - Содержимое (body_html, body_text)
        - Переменные для подстановки (variables — список {name, description, required})
        - Статистика использования (usage_count, last_used_at)
      
      parameters:
        - in: path
          name: template_id
          required: true
          schema:
            type: string
          description: Идентификатор шаблона письма
          example: 'ФТ-022'
      
      responses:
        '200':
          description: Детали шаблона получены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TemplateDetails'
        
        '404':
          description: Шаблон не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    
  /templates/{template_id}:
    put:
      tags:
        - Администрирование
      operationId: updateTemplate
      summary: Обновление шаблона письма
      description: |
        Обновление содержимого и параметров шаблона письма.
      
      parameters:
        - in: path
          name: template_id
          required: true
          schema:
            type: string
        
        - in: header
          name: Idempotency-Key
          required: true
          schema:
            type: string
            format: uuid
      
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TemplateUpdateRequest'
      
      responses:
        '200':
          description: Шаблон успешно обновлен
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: 'updated'
                  template_id:
                    type: string
                  updated_at:
                    type: string
                    format: date-time
                  updated_by:
                    type: string
                    format: uuid
        
        '404':
          description: Шаблон не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '422':
          description: Ошибка валидации шаблона
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'

  /retry/list:
    get:
      tags:
        - Администрирование
      operationId: getUnsendEmailsList
      summary: Список неотправленных писем
      description: |
        Возвращает список писем, которые не были отправлены из-за ошибок.
        
      parameters:
        - in: query
          name: date_from
          required: false
          schema:
            type: string
            format: date
          description: Начало периода для фильтрации
        
        - in: query
          name: date_to
          required: false
          schema:
            type: string
            format: date
          description: Конец периода для фильтрации
        
        - in: query
          name: template_id
          required: false
          schema:
            type: string
          description: Фильтр по шаблону письма
        
        - in: query
          name: page
          required: false
          schema:
            type: integer
            default: 1
        
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            default: 50
      
      responses:
        '200':
          description: Список неотправленных писем получен
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
                  unsend_emails:
                    type: array
                    items:
                      $ref: '#/components/schemas/UnsendEmailItem'

  /retry/send:
    post:
      tags:
        - Администрирование
      operationId: retrySendEmails
      summary: Переотправка выбранных писем
      description: |
        Ручная переотправка неудачно отправленных писем.
      
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                  description: Массив ID неотправленных писем
                  minItems: 1
                  maxItems: 100
              required:
                - email_ids
      
      responses:
        '200':
          description: Письма успешно переотправлены
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: 'retry_initiated'
                  total_emails:
                    type: integer
                  successful:
                    type: integer
                  failed:
                    type: integer

    # ============================================
    # Статистика и мониторинг
    # ============================================

  /statistics/summary:
    get:
      tags:
        - Статистика и мониторинг
      operationId: getStatisticsSummary
      summary: Просмотр статистики коммуникаций
      description: |
        Возвращает агрегированную статистику по email коммуникациям.

      parameters:
        - in: query
          name: date_from
          required: true
          schema:
            type: string
            format: date
          description: Начало периода
        
        - in: query
          name: date_to
          required: true
          schema:
            type: string
            format: date
          description: Конец периода
        
        - in: query
          name: template_id
          required: false
          schema:
            type: string
          description: Фильтр по шаблону письма
        
        - in: query
          name: group_by
          required: false
          schema:
            type: string
            enum: ['day', 'week', 'month', 'template']
            default: 'day'
          description: Группировка результатов
      
      responses:
        '200':
          description: Статистика успешно получена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatisticsSummaryResponse'


  /statistics/export/csv:
    get:
      tags:
        - Статистика и мониторинг
      operationId: exportStatisticsCSV
      summary: Экспорт статистики в CSV
      description: |
        Экспортирует статистику в CSV файл для анализа.
        
        **Используется в:** ФТ-017 (формирование отчётов)
      
      parameters:
        - in: query
          name: date_from
          required: true
          schema:
            type: string
            format: date
          description: Начало периода
        
        - in: query
          name: date_to
          required: true
          schema:
            type: string
            format: date
          description: Конец периода
        
        - in: query
          name: template_id
          required: false
          schema:
            type: string
      
      responses:
        '200':
          description: CSV файл статистики
          content:
            text/csv:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
              description: 'attachment; filename="statistics_YYYY-MM-DD_YYYY-MM-DD.csv"'

  /logs:
    get:
      tags:
        - Статистика и мониторинг
      operationId: getSystemLogs
      summary: Просмотр логов системы
      description: |
        Просмотр системных логов с фильтрацией.
        
        **Используется в:** НФТ-5.1 (логирование событий)
      
      parameters:
        - in: query
          name: date_from
          required: false
          schema:
            type: string
            format: date-time
          description: Начало периода
        
        - in: query
          name: date_to
          required: false
          schema:
            type: string
            format: date-time
          description: Конец периода
        
        - in: query
          name: level
          required: false
          schema:
            type: string
            enum: ['INFO', 'WARNING', 'ERROR', 'CRITICAL']
          description: Уровень логирования
        
        - in: query
          name: component
          required: false
          schema:
            type: string
            enum: ['email', 'payment', 'subscription', 'moderation', 'webhook']
          description: Компонент системы
        
        - in: query
          name: search_text
          required: false
          schema:
            type: string
          description: Полнотекстовый поиск по сообщениям
        
        - in: query
          name: page
          required: false
          schema:
            type: integer
            default: 1
        
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            default: 100
            maximum: 500
      
      responses:
        '200':
          description: Логи успешно получены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogsResponse'

  /logs/export/csv:
    get:
      tags:
        - Статистика и мониторинг
      operationId: exportLogsCSV
      summary: Экспорт логов в CSV
      description: Экспорт системных логов в CSV файл
      
      parameters:
        - in: query
          name: date_from
          required: true
          schema:
            type: string
            format: date-time
          description: Начало периода
        
        - in: query
          name: date_to
          required: true
          schema:
            type: string
            format: date-time
          description: Конец периода
        
        - in: query
          name: level
          required: false
          schema:
            type: string
            enum: ['INFO', 'WARNING', 'ERROR', 'CRITICAL']
        
        - in: query
          name: component
          required: false
          schema:
            type: string
      
      responses:
        '200':
          description: CSV файл логов
          content:
            text/csv:
              schema:
                type: string
                format: binary

  /monitoring/services:
    get:
      tags:
        - Статистика и мониторинг
      operationId: getServicesStatus
      summary: Получение статуса сервисов и подсистем
      description: |
        Возвращает текущий статус всех интеграционных сервисов.
        
        **Используется в:** НФТ-5.2 (мониторинг здоровья интеграционных точек)
      
      parameters:
        - in: query
          name: service_name
          required: false
          schema:
            type: string
          description: Фильтр по названию сервиса
      
      responses:
        '200':
          description: Статус сервисов получен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServicesStatusResponse'

  /monitoring/queues:
    get:
      tags:
        - Администрирование
      operationId: getQueuesStatus
      summary: Получение статуса очередей
      description: Возвращает статус внутренних очередей сообщений
      
      responses:
        '200':
          description: Статус очередей получен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueuesStatusResponse'

  /monitoring/alerts:
    get:
      tags:
        - Статистика и мониторинг
      operationId: getActiveAlerts
      summary: Получение активных алертов
      description: Возвращает список активных алертов и предупреждений
      
      parameters:
        - in: query
          name: severity
          required: false
          schema:
            type: string
            enum: ['low', 'medium', 'high', 'critical']
          description: Фильтр по уровню опасности
        
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            default: 100
      
      responses:
        '200':
          description: Список алертов получен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertsResponse'

components:
  schemas:
    EmailSendRequest:
      type: object
      properties:
        template_id:
          description: идентификатор шаблона письма
          type: string
          format: uuid
          example: 37b51ee9-2c41-4403-9444-0818da6d22d0
        recipient_email:
          description: адрес получателя письма
          type: string
          format: email
        vars:
          type: object
          description: |
            Переменные для подстановки в шаблоне письма.
            Для каждого типа письма используйте только релевантные переменные. Список необходимых переменных см. в документации к шаблонам.
          example:
            total_amount: '5000'
            event_name: День рождения Фонда
        list_id:
          description: |
            идентификатор списка благотворителей для данного События при отправке 
            письма группе адресатов.
          type: string
          format: uuid
          example: 93e6b492-1234-42be-8c67-d1c96d5a8d7c
        body:
          description: тело письма в формате HTML. Используется при отправлении письма без шаблона.
          type: string
          format: html
          example: <p>Спасибо за участие в событии <b>День рождения Фонда</b>!</p>
        subject:
          description: Тема письма для отправки. Используется при отправки без шаблона или при переопределении темы.
          type: string
          example: Поздравляем с успешным завершением сбора!
    SubscriberRequest:
      type: object
      properties:
        user_email:
          description: email в список для рассылки
          type: string
          format: email
        list_id:
          description: идентификатор списка рассылки
          type: string
          format: uuid
          example: 1f45babf-9315-4b97-99ef-abda630dafb7
        source:
          description: источник email для добавления в рассылку
          type: string
          enum:
            - registration
            - donation
          example: registration
        timestamp:
          description: время рассылки
          type: string
          format: date-time
      required:
        - user_email
        - list_id
    UnisenderGoWebhook:
      type: object
      description: |
        Webhook событие от UnisenderGo о статусе доставки писем.
        
        **Возможные события:**
        - `delivered` — письмо доставлено
        - `opened` — письмо открыто
        - `clicked` — клик по ссылке
        - `bounced` — письмо вернулось
        - `unsubscribed` — отписка
      
      properties:
        event:
          type: string
          enum: [delivered, opened, clicked, bounced, unsubscribed]
          description: Тип события
        
        email_id:
          type: string
          format: uuid
          description: Внутренний ID письма в системе интеграции
        
        message_id:
          type: string
          description: ID письма в UnisenderGo
        
        recipient_email:
          type: string
          format: email
          description: Email адрес получателя
        
        template_id:
          type: string
          description: ID использованного шаблона
        
        delivered_at:
          type: string
          format: date-time
          description: (Для события 'delivered') Timestamp доставки
        
        opened_at:
          type: string
          format: date-time
          description: (Для события 'opened') Timestamp открытия
        
        clicked_at:
          type: string
          format: date-time
          description: (Для события 'clicked') Timestamp клика
        
        url:
          type: string
          format: uri
          description: (Для события 'clicked') URL по которому кликнули
        
        bounce_type:
          type: string
          enum: [hard, soft]
          description: (Для события 'bounced') Тип bounce
        
        bounce_reason:
          type: string
          description: (Для события 'bounced') Причина bounce
        
        user_agent:
          type: string
          description: User-Agent браузера/почтового клиента
        
        ip_address:
          type: string
          format: ipv4
          description: IP адрес получателя
      
      required:
        - event
        - email_id
        - message_id
        - recipient_email
        - template_id

    EventListItem:
      type: object
      description: Перечень всех Событий на модерации
      properties:
        event_id:
          type: string
          format: uuid
          description: Идентификатор события
          example: e995f12b-abcd-4c2d-b174-bd622174807f
        event_name:
          type: string
          description: Название события
          example: Веломарафон помощи
        created_at:
          type: string
          format: date-time
          description: Дата и время создания события
          example: '2026-02-12T07:40:00Z'
        status:
          type: string
          description: Текущий статус события
          example: pending_moderation
        event_creator_email:
          type: string
          format: email
          description: 'email Пользователя, создавшего Событие'
          example: roberta@rabotta.ru
        target_amount:
          type: integer
          description: Целевая сумма сбора
          example: 30000
    EventDetails:
      type: object
      description: Схема для вывода всех параметров выбранного События для принятия решения по модерации
      properties:
        event_id:
          type: string
          format: uuid
          description: Идентификатор события
          example: e995f12b-abcd-4c2d-b174-bd622174807f
        admin_id:
          type: string
          format: uuid
          description: Идентификатор администратора (внутренний ID или UUID).
          example: 321efdce-174a-46eb-849c-c2ffbb1c8d60
        event_name:
          type: string
          description: Название события.
          example: Благотворительный марафон
        event_creator_email:
          type: string
          format: email
          description: 'Email пользователя, создавшего  Cобытие.'
          example: roberta@rabotta.ru
        event_description:
          type: string
          description: Описание события.
        images_count:
          type: integer
          description: 'Количество изображений, приложенных к Cобытию.'
          example: 3
        target_amount:
          type: integer
          description: Целевая сумма сбора для события.
          example: 50000
        event_date_from:
          type: string
          format: date
          description: Дата начала Cобытия.
          example: '2025-12-01'
      required:
        - event_id
    EventApproveRequest:
      type: object
      description: Схема для подтверждения (одобрения) события администратором.
      properties:
        admin_id:
          type: string
          format: uuid
          description: Идентификатор администратора (внутренний ID или UUID).
          example: 321efdce-174a-46eb-849c-c2ffbb1c8d60
        event_name:
          type: string
          description: Название события.
          example: Благотворительный марафон
        event_creator_email:
          type: string
          format: email
          description: 'Email пользователя, создавшего  Cобытие.'
          example: roberta@rabotta.ru
        event_description:
          type: string
          description: Описание события.
        images_count:
          type: integer
          description: 'Количество изображений, приложенных к Cобытию.'
          example: 3
        target_amount:
          type: integer
          description: Целевая сумма сбора для события.
          example: 50000
        event_date_from:
          type: string
          format: date
          description: Дата начала Cобытия.
          example: '2025-12-01'
        event_date_to:
          type: string
          format: date
          description: Дата завершения Cобытия.
          example: '2026-01-15'
        comment:
          type: string
          description: Комментарий администратора (необязательный).
          example: Все документы проверены
      required:
        - admin_id
        - event_name
        - event_creator_email
        - event_date_to
    EventRejectRequest:
      type: object
      description: Схема для отклонения события администратором.
      properties:
        admin_id:
          type: string
          format: uuid
          description: Идентификатор администратора.
          example: 321efdce-174a-46eb-849c-c2ffbb1c8d60
        event_name:
          type: string
          description: Название События.
          example: Благотворительный марафон
        event_creator_email:
          type: string
          format: email
          description: 'Email пользователя, создавшего Событие.'
          example: roberta@rabotta.ru
        event_description:
          type: string
          description: Описание События.
        images_count:
          type: integer
          description: 'Количество изображений, приложенных к Событию.'
          example: 3
        target_amount:
          type: integer
          description: Целевая сумма сбора для События.
          example: 50000
        event_date_finish:
          type: string
          format: date
          description: Дата отклонения события (текущая дата).
          example: '2025-12-01'
        rejection_reason:
          type: string
          description: Подробный комментарий/причина отказа.
          example: В предоставленных документах нет подтверждения цели сбора
      required:
        - admin_id
        - event_name
        - event_creator_email
        - rejection_reason

    PaymentRequest:
      type: object
      description: Запрос на инициирование платежа
      properties:
        donor_amount:
          type: integer
          description: |
            Сумма пожертвования в копейках (для точности).
            Например, для 5000 рублей передать 500000.
            **Формула:** amount_in_rubles * 100
          example: 500000
        
        currency:
          type: string
          enum: ['RUB']
          description: Валюта платежа (только рубли)
          example: 'RUB'
        
        donor_email:
          type: string
          format: email
          description: Email благотворителя
      
      required:
        - donor_amount
        - currency
        - donor_email
      
    SubscriptionRequest:
      type: object
      description: Запрос на создание рекуррентной подписки
      properties:
        recurrent_email:
          type: string
          format: email
          description: Email рекуррентного благотворителя
        
        recurrent_amount:
          type: integer
          description: |
            Сумма платежа в копейках (ежемесячная).
            **Формула:** amount_in_rubles * 100
          example: 100000
        
        currency:
          type: string
          enum: ['RUB']
          example: 'RUB'
        
        frequency:
          type: string
          enum: ['monthly', 'quarterly', 'semi_annually', 'annually']
          description: |
            Периодичность списаний:
            - monthly — каждый месяц
            - quarterly — раз в квартал (3 месяца)
            - semi_annually — два раза в год
            - annually — один раз в год
          example: 'monthly'
        
        event_id:
          type: string
          format: uuid
          description: Идентификатор События для подписки
        
        agree_newsletter:
          type: boolean
          description: Согласие на рассылку
        
        start_date:
          type: string
          format: date
          description: Дата первого списания (опционально, по умолчанию сегодня)
      
      required:
        - recurrent_email
        - recurrent_amount
        - currency
        - frequency
        - event_id

    SubscriptionCancelRequest:
      type: object
      description: Запрос на отмену подписки
      properties:
        donor_email:
          type: string
          format: email
          description: Email благотворителя
        
        reason:
          type: string
          enum: ['user_requested', 'failed_after_4_retries']
          description: |
            Причина отмены:
            - user_requested — отмена по инициативе пользователя
            - failed_after_4_retries — отмена из-за 4 неудачных платежей
        
        cancellation_reason_text:
          type: string
          description: (Опционально) Текстовое описание причины отмены
          maxLength: 500
      
      required:
        - donor_email
        - reason
      
    CloudPaymentWebhook:
      type: object
      description: Webhook успешного платежа от CloudPayments
      properties:
        TransactionId:
          type: string
          description: Идентификатор транзакции в CloudPayments
        
        Amount:
          type: number
          description: Сумма платежа (в рублях, не в копейках)
        
        Currency:
          type: string
          enum: ['RUB']
        
        Email:
          type: string
          format: email
          description: Email платильщика
        
        Status:
          type: string
          enum: ['Completed']
          description: Статус платежа
      
      required:
        - TransactionId
        - Amount
        - Currency
        - Email
        - Status

    CloudPaymentFailWebhook:
      type: object
      description: Webhook ошибки платежа от CloudPayments
      properties:
        TransactionId:
          type: string
        
        Amount:
          type: number
        
        Currency:
          type: string
        
        Email:
          type: string
          format: email
        
        Reason:
          type: string
          description: Причина отказа в платеже
        
        Status:
          type: string
          enum: ['Declined', 'Cancelled', 'AuthenticationFailed']

    CloudPaymentSubscriptionWebhook:
      type: object
      description: Webhook ежемесячного списания по подписке
      properties:
        SubscriptionId:
          type: string
          description: ID подписки в CloudPayments
        
        Amount:
          type: number
          description: Сумма платежа (в рублях)
        
        Currency:
          type: string
        
        Email:
          type: string
          format: email
        
        Status:
          type: string
          enum: ['Completed', 'Declined']
        
        PaymentNumber:
          type: integer
          description: Номер платежа по подписке (1, 2, 3...)
        
        CreatedDate:
          type: string
          description: Дата/время платежа

    TemplateListItem:
      type: object
      description: Элемент в списке шаблонов
      properties:
        template_id:
          type: string
          example: 'ФТ-022'
        
        subject:
          type: string
          description: Тема письма
        
        description:
          type: string
          description: Описание назначения шаблона
        
        last_modified:
          type: string
          format: date-time
        
        variables_count:
          type: integer
          description: Количество переменных для подстановки

    TemplateUpdateRequest:
      type: object
      description: Данные для обновления шаблона
      properties:
        subject:
          type: string
          description: Тема письма
        
        body_html:
          type: string
          format: html
          description: HTML-версия содержимого
        
        body_text:
          type: string
          description: Текстовая версия содержимого
        
        variables:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              
              description:
                type: string
              
              required:
                type: boolean

    TemplateDetails:
      type: object
      description: |
        Полная информация о шаблоне письма.
        
        **Содержит все параметры шаблона:**
        - Идентификаторы и метаинформация
        - HTML и текстовая версии содержимого
        - Список переменных для подстановки
        - Статистика использования
        - Даты создания и обновления
      
      properties:
        template_id:
          type: string
          example: 'FT-022'
        
        subject:
          type: string
          description: Тема письма
          example: 'Добро пожаловать!'
        
        description:
          type: string
          description: Описание назначения и использования шаблона
        
        body_html:
          type: string
          format: html
          description: HTML-версия содержимого письма
        
        body_text:
          type: string
          description: Текстовая версия содержимого письма (для клиентов без поддержки HTML)
        
        variables:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
                description: Имя переменной (используется в шаблоне как {{name}})
                example: 'user_name'
              
              description:
                type: string
                description: Описание переменной для администратора
                example: 'Имя пользователя'
              
              required:
                type: boolean
                description: Обязательная ли переменная
              
              example_value:
                type: string
                description: Пример значения переменной
          description: Массив переменных, используемых в шаблоне
        
        usage_count:
          type: integer
          description: Количество раз, когда был использован шаблон
        
        last_used_at:
          type: string
          format: date-time
          description: Дата последнего использования
        
        created_at:
          type: string
          format: date-time
        
        updated_at:
          type: string
          format: date-time
        
        updated_by:
          type: string
          format: uuid
          description: UUID администратора, который последний раз редактировал шаблон

    UnsendEmailItem:
      type: object
      description: Элемент в списке неотправленных писем
      properties:
        unsent_email_id:
          type: string
          format: uuid
        
        template_id:
          type: string
        
        recipient_email:
          type: string
          format: email
        
        failed_at:
          type: string
          format: date-time
        
        error_message:
          type: string
          description: Сообщение об ошибке
        
        retry_attempts:
          type: integer
          description: Количество выполненных повторных попыток
        
        max_retries:
          type: integer
          description: Максимальное количество повторных попыток

    StatisticsSummaryResponse:
      type: object
      description: Агрегированная статистика коммуникаций
      properties:
        period:
          type: object
          properties:
            date_from:
              type: string
              format: date
            
            date_to:
              type: string
              format: date
        
        total_sent:
          type: integer
          description: Всего отправлено писем
        
        total_delivered:
          type: integer
          description: Доставлено писем
        
        total_opened:
          type: integer
          description: Открыто писем
        
        total_clicked:
          type: integer
          description: Кликов по ссылкам
        
        total_bounced:
          type: integer
          description: Вернулось писем (bounce)
        
        metrics:
          type: object
          description: Расчетные метрики (OR, DR, CTR, CTOR)
          properties:
            delivery_rate:
              type: number
              format: float
              description: 'Процент доставленных писем (DR = delivered / sent * 100)'
            
            open_rate:
              type: number
              format: float
              description: 'Процент открытых писем (OR = opened / delivered * 100)'
            
            click_through_rate:
              type: number
              format: float
              description: 'Процент кликов (CTR = clicked / sent * 100)'
            
            click_to_open_rate:
              type: number
              format: float
              description: 'Процент кликов среди открывших (CTOR = clicked / opened * 100)'
        
        by_template:
          type: array
          items:
            type: object
            properties:
              template_id:
                type: string
              
              sent:
                type: integer
              
              delivered:
                type: integer
              
              opened:
                type: integer

    LogsResponse:
      type: object
      description: Ответ с логами системы
      properties:
        total:
          type: integer
        
        page:
          type: integer
        
        limit:
          type: integer
        
        logs:
          type: array
          items:
            type: object
            properties:
              timestamp:
                type: string
                format: date-time
              
              level:
                type: string
                enum: [INFO, WARNING, ERROR, CRITICAL]
              
              component:
                type: string
              
              message:
                type: string
              
              request_id:
                type: string
                format: uuid
              
              user_id:
                type: string
                format: uuid
              
              ip_address:
                type: string
                format: ipv4

    ServicesStatusResponse:
      type: object
      description: Статус интеграционных сервисов
      properties:
        services:
          type: array
          items:
            type: object
            properties:
              service_name:
                type: string
                enum: [UnisenderGo, Unisender, CloudPayments, Bitrix]
              
              status:
                type: string
                enum: [healthy, degraded, unavailable]
              
              last_check_at:
                type: string
                format: date-time
              
              response_time_ms:
                type: integer
                description: Время ответа сервиса в миллисекундах
              
              error_message:
                type: string
                description: Сообщение об ошибке (если статус не healthy)

    QueuesStatusResponse:
      type: object
      description: Статус внутренних очередей
      properties:
        queues:
          type: array
          items:
            type: object
            properties:
              queue_name:
                type: string
                enum: [email_sending, webhook_processing, retry_queue, dead_letter_queue]
              
              pending_count:
                type: integer
                description: Количество задач в очереди
              
              processing_count:
                type: integer
                description: Количество задач в обработке
              
              oldest_task_age_seconds:
                type: integer
                description: Возраст старейшей задачи в секундах

    AlertsResponse:
      type: object
      description: Список активных алертов и предупреждений
      properties:
        total:
          type: integer
        
        alerts:
          type: array
          items:
            type: object
            properties:
              alert_id:
                type: string
                format: uuid
              
              severity:
                type: string
                enum: [low, medium, high, critical]
              
              title:
                type: string
                description: Краткое название алерта
              
              message:
                type: string
                description: Подробное описание алерта
              
              created_at:
                type: string
                format: date-time
              
              component:
                type: string
                description: Компонент системы, вызвавший алерт
    
    # ============================================
    # Ошибки и валидация
    # ============================================
    
    ErrorResponse:
      type: object
      description: Стандартный ответ об ошибке
      properties:
        error_code:
          type: string
          description: Машиночитаемый код ошибки
          example: 'INVALID_REQUEST'
        
        error_message:
          type: string
          description: Читаемое описание ошибки
          example: 'Некорректные параметры запроса'
        
        timestamp:
          type: string
          format: date-time
          description: Timestamp ошибки (ISO 8601)
          example: '2025-11-13T15:27:45.123Z'
        
        request_id:
          type: string
          format: uuid
          description: ID запроса для трассировки в логах
      
      required:
        - error_code
        - error_message
        - timestamp

    ValidationErrorResponse:
      type: object
      description: Ответ при ошибке валидации данных
      allOf:
        - $ref: '#/components/schemas/ErrorResponse'
        - type: object
          properties:
            field:
              type: string
              description: Поле, в котором обнаружена ошибка
            
            value:
              description: Некорректное значение
            
            validation_rule:
              type: string
              description: Описание правила валидации

    RateLimitErrorResponse:
      type: object
      description: Ответ при превышении лимита запросов (429)
      allOf:
        - $ref: '#/components/schemas/ErrorResponse'
        - type: object
          properties:
            retry_after:
              type: integer
              description: Количество секунд до следующей попытки
              example: 120
            
            rate_limit:
              type: object
              properties:
                limit:
                  type: integer
                  description: Максимальное количество запросов в час
                  example: 1000
                
                remaining:
                  type: integer
                  description: Оставшееся количество запросов
                  example: 0
                
                reset_at:
                  type: string
                  format: date-time

    ServerErrorResponse:
      type: object
      description: Ответ при ошибке сервера (5xx)
      allOf:
        - $ref: '#/components/schemas/ErrorResponse'
        - type: object
          properties:
            retry_info:
              type: object
              properties:
                max_retries:
                  type: integer
                  example: 3
                
                current_retry:
                  type: integer
                  example: 0
                
                next_retry_at:
                  type: string
                  format: date-time

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT токен для аутентификации.

        Получить можно через эндпоинт `/auth/login` (планируется разработать в ходе дальнейших работ по Платформе).
        
        ```python
        Authorization: Bearer <JWT_token>
        ```
        
  examples:
    IdempotentRequestExample:
      summary: Пример запроса с идемпотентным ключом
      value:
        headers:
          Authorization: Bearer your_access_token
          Idempotency-Key: 3fa85f64-5717-4562-b3fc-2c963f66afa6
        body:
          donor_email: roberta@rabotta.ru
          donor_amount: 5000
          event_id: e995f12b-abcd-4c2d-b174-bd622174807f
          agree_newsletter: true
          currency: RUB

security:
  - bearerAuth: []