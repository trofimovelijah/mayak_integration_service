@startuml Events

' Определение участников диаграммы
actor "Пользователь" as User #Red
actor "Благотворитель" as Donor #Green
actor "Администратор" as Admin #Gray 
participant "1С-\nБитрикс" as Bitrix #RosyBrown
participant "Сервис\n интеграции" as IntService #SkyBlue
participant "Сервис рассылки\n UnisenderGo" as UnisenderGo #GreenYellow
participant "Сервис рассылки\n Unisender" as Unisender #GreenYellow

' Описание последовательности сообщений
== ФТ-022 Регистрация на Платформе ==
User -> Bitrix: Отправлены данные для регистрации
Bitrix -> IntService: Регистрация на Платформе\n POST /email/send
activate IntService

IntService -> IntService: Проверка дедупликации + валидация email RFC 5322

alt Регистрация успешна
    opt
        IntService -> IntService: Добавление с список рассылки\n POST /email/subscribe
        IntService -> Unisender: POST https://www.unisender.com/ru/support/api/messages/createemailmessage/\n POST /email/subscribers
        Unisender --> IntService: Webhook        
    end
    IntService -> UnisenderGo: POST https://godocs.unisender.ru/web-api-ref#email-send\n POST /email/send
    UnisenderGo --> IntService: Webhook
    IntService --> Bitrix: 200 ОК
    IntService --> User: Письмо с благодарностью за регистрацию
     
else Регистрация не удалась
    IntService --> Bitrix: Ответ с ошибкой
    deactivate
    Bitrix --> User: Ответ с ошибкой
end 

== ФТ-021 Предложение создать Событие через 7 суток после регистрации ==
Bitrix -> IntService: Триггер об отправке письма\n POST /email/send
activate IntService
IntService --> IntService: Проверка создания События
alt Отправка письма
    IntService -> UnisenderGo: POST https://godocs.unisender.ru/web-api-ref#email-send\n POST /email/send
    UnisenderGo --> IntService: 200 OK
    IntService --> User: Письмо с предложением создать Событие
else Событие ранее создано
    IntService --> Bitrix: Событие создано ранее\n GET /event/{event_id}
    deactivate IntService
end

== ФТ-024 Создание События и отправка его на Модерацию ==
User -> Bitrix: Выполнен вход на Платформе
activate Bitrix
Bitrix -> User: Вход успешен
User -> Bitrix: Добавлено новое Событие
Bitrix -> IntService: POST /email/moderation
deactivate Bitrix
activate IntService
IntService -> IntService: Валидация данных письма
IntService -> UnisenderGo: Отправка письма Администратору\n POST https://godocs.unisender.ru/web-api-ref#email-send\n POST /email/send
deactivate IntService
activate UnisenderGo

newpage

== ФТ-025, ФТ-026 Модерация События == 
UnisenderGo --> IntService: Событие пришло на Модерацию\n Webhook 200 OK {email_id}
activate IntService
deactivate UnisenderGo
Admin -> IntService: Запрос списка Событий на Модерацию\n GET /events?status=pending_moderation
activate Admin
IntService -> Admin: Список Событий на Модерацию
Admin -> IntService: Просмотр деталей События\n GET /events/{event_id}
IntService --> Admin: Детали События
deactivate Admin
deactivate IntService
alt Событие одобрено для размещения на Платформе
    Admin -> IntService: Одобрение События\n POST /event/{event_id}/approve
    activate IntService
    IntService -> Bitrix: Статус "Опубликовано"
    IntService -> UnisenderGo: POST /email/send
    activate UnisenderGo
    UnisenderGo --> IntService: Webhook: delivered
    deactivate IntService
    UnisenderGo --> User: Письмо: Событие опубликовано! (ФТ-025)
    deactivate UnisenderGo
else Событие отклонено
    Admin -> IntService: Отклонение События\n POST /event/{event_id}/reject
    activate IntService
    IntService -> Bitrix: Статус "Отклонено"\n 200 OK {email_id}
    IntService -> UnisenderGo: POST /email/send
    activate UnisenderGo
    UnisenderGo --> IntService: Webhook: delivered\n 200 OK {email_id}
    deactivate IntService
    UnisenderGo --> User: Письмо: Событие не прошло модерацию (ФТ-026)
    deactivate UnisenderGo
end

== ФТ-003, ФТ-006, ФТ-027 Завершение События ==
Bitrix -> IntService: Триггер о завершении События\n POST /events/closed
activate IntService
IntService -> IntService: Выбор шаблона письма о результатах сбора
deactivate IntService

alt Сумма ненулевая
    par Уведомить автора События по ФТ-003
        IntService -> UnisenderGo: Отправка письма о завершении сбора\n POST /email/send
activate IntService
activate UnisenderGo
        UnisenderGo --> IntService: Webhook\n 200 OK {email_id}
        UnisenderGo --> User: Письмо о завершении Сбора
    else Уведомить Благотворителей по ФТ-003
        IntService -> UnisenderGo: Отправка письма о завершении сбора\n POST /email/send
        UnisenderGo --> IntService: Webhook\n 200 OK {email_id}    
        UnisenderGo --> Donor: Письмо о завершении Сбора
    end
else Сумма сбора равна 0 по ФТ-027
    IntService -> UnisenderGo: Отправка письма о завершении сбора\n POST /email/send
    UnisenderGo --> IntService: Webhook\n 200 OK {email_id}
deactivate IntService
    UnisenderGo --> User: Письмо о завершении Сбора создателю сбора
deactivate UnisenderGo
end

== Предложение создать События за 14 суток до др ==
Bitrix -> IntService: Триггер о дате Пользователя\n POST /emails/send
activate IntService
IntService -> UnisenderGo: Отправка письма с предложением создать Событие\n POST /email/send
activate UnisenderGo
UnisenderGo --> IntService: Webhook\n 200 OK {email_id}
deactivate IntService
UnisenderGo --> User: Письмо с предложением создать Событие к др
deactivate UnisenderGo

@enduml