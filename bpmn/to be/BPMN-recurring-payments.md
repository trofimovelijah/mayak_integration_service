# BPMN TO-BE: Процесс рекуррентных платежей (Detailed Specification)

## Общая информация

**Название процесса**: Управление рекуррентными платежами и связанные коммуникации  
**Версия**: 1.0  
**Дата**: 01.11.2025  
**Статус**: TO-BE (Целевое состояние)

---

## Архитектурные решения

- **Админ-панель**: Встроена в интеграционный сервис (без отдельного сервиса администратора)
- **База данных**: Единая для интеграционного сервиса и админ-панели
- **Платежные системы**: CloudPayments и MixPlat (функциональность идентична)
- **Email сервис**: Unisender Go (единственный канал отправки)

---

## Пулы (Pools) и дорожки (Lanes)

### Pool 1: Благотворитель (Донор)
- **Lane 1.1**: Оформление подписки
- **Lane 1.2**: Управление подпиской
- **Lane 1.3**: Получение уведомлений

### Pool 2: Платформа (Битрикс)
- **Lane 2.1**: Хранение данных подписок
- **Lane 2.2**: Генерация триггеров рекуррентных платежей

### Pool 3: Интеграционный сервис (Python)
- **Lane 3.1**: Обработка триггеров подписок
- **Lane 3.2**: Валидация и бизнес-правила
- **Lane 3.3**: Управление рекуррентными платежами
- **Lane 3.4**: Эскалация и автоматическая отмена
- **Lane 3.5**: Логирование

### Pool 4: БД интеграционного сервиса
- **Lane 4.1**: Таблица subscriptions
- **Lane 4.2**: Таблица recurring_transactions
- **Lane 4.3**: Таблица retry_queue

### Pool 5: Платежные системы (CloudPayment/MixPlat)
- **Lane 5.1**: Обработка рекуррентных списаний
- **Lane 5.2**: Обработка ошибок платежей

### Pool 6: Unisender Go
- **Lane 6.1**: Отправка писем
- **Lane 6.2**: Управление списками рассылки

### Pool 7: Администратор
- **Lane 7.1**: Просмотр статистики подписок
- **Lane 7.2**: Ручное управление подписками

---

## Процесс: Полный цикл рекуррентных платежей

### Часть 1: Оформление подписки (при пожертвовании)

#### Start Event
- **ID**: SE_RC_100
- **Название**: "Благотворитель выбирает рекуррентный платеж"
- **Тип**: None Start Event
- **Pool**: Благотворитель
- **Lane**: 1.1 Оформление подписки

#### Task 1: Выбор периодичности
- **ID**: UT_RC_100
- **Название**: "Выбор 'Ежемесячная подписка'"
- **Тип**: User Task
- **Pool**: Благотворитель
- **Lane**: 1.1
- **Входящие потоки**: SE_RC_100
- **Исходящие потоки**: UT_RC_101
- **Описание**: При оформлении пожертвования благотворитель выбирает опцию "Ежемесячно"

#### Task 2: Ввод данных карты
- **ID**: UT_RC_101
- **Название**: "Ввод реквизитов карты и согласие"
- **Тип**: User Task
- **Pool**: Благотворитель
- **Lane**: 1.1
- **Входящие потоки**: UT_RC_100
- **Исходящие потоки**: UT_RC_102
- **Форма**: subscription_form
- **Поля**: card_number, card_holder, expiry_date, cvv, agree_terms

#### Task 3: Чек-бокс согласия на рассылку (ФТ-020)
- **ID**: UT_RC_102
- **Название**: "Отметить чек-бокс 'Хочу получать рассылку'"
- **Тип**: User Task
- **Pool**: Благотворитель
- **Lane**: 1.1
- **Входящие потоки**: UT_RC_101
- **Исходящие потоки**: ST_RC_100
- **Описание**: Опциональный чек-бокс для согласия на email коммуникацию
- **ФТ**: ФТ-020 "Соглашение на рассылку по электронной почте"

#### Task 4: Отправка данных на платежную систему
- **ID**: ST_RC_100
- **Название**: "Отправка запроса на создание подписки"
- **Тип**: Send Task
- **Pool**: Благотворитель
- **Lane**: 1.1
- **Входящие потоки**: UT_RC_102
- **Исходящие потоки**: MSG_RC_100

#### Message Flow 1
- **ID**: MSG_RC_100
- **От**: ST_RC_100 (Pool: Благотворитель)
- **К**: ST_RC_101 (Pool: Платежные системы)

#### Task 5: Создание подписки (Платежная система)
- **ID**: ST_RC_101
- **Название**: "Создание рекуррентной подписки"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платежные системы (CloudPayment/MixPlat)
- **Lane**: 5.1 Обработка рекуррентных списаний
- **Входящие потоки**: MSG_RC_100
- **Исходящие потоки**: ST_RC_102
- **API**: 
  - CloudPayments: `POST /api/v3/subscriptions`
  - MixPlat: `POST /subscriptions/create`
- **Payload**:
```json
{
  "account_id": "...",
  "amount": 5000.00,
  "currency": "RUB",
  "start_date": "2025-11-01",
  "interval": "month",
  "period": 1,
  "card_token": "...",
  "description": "Благотворительный сбор"
}
```

#### Task 6: Callback о создании подписки
- **ID**: ST_RC_102
- **Название**: "Отправка callback успеха"
- **Тип**: Send Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платежные системы
- **Lane**: 5.1
- **Входящие потоки**: ST_RC_101
- **Исходящие потоки**: MSG_RC_101
- **Payload**:
```json
{
  "status": "success",
  "subscription_id": "SUB123456",
  "account_id": "...",
  "amount": 5000.00,
  "interval": "month",
  "created_at": "2025-11-01T10:00:00Z"
}
```

#### Message Flow 2
- **ID**: MSG_RC_101
- **От**: ST_RC_102 (Pool: Платежные системы)
- **К**: RT_RC_100 (Pool: Платформа Битрикс)

#### Task 7: Получение callback (Битрикс)
- **ID**: RT_RC_100
- **Название**: "Получение данных о подписке"
- **Тип**: Receive Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платформа (Битрикс)
- **Lane**: 2.2 Генерация триггеров
- **Входящие потоки**: MSG_RC_101
- **Исходящие потоки**: ST_RC_110

#### Task 8: Сохранение подписки в Битрикс
- **ID**: ST_RC_110
- **Название**: "Сохранение в таблицу subscriptions"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платформа (Битрикс)
- **Lane**: 2.1 Хранение данных подписок
- **Входящие потоки**: RT_RC_100
- **Исходящие потоки**: ST_RC_111
- **SQL**:
```sql
INSERT INTO subscriptions (
  subscription_id, 
  donor_email, 
  donor_name, 
  amount, 
  frequency, 
  status, 
  payment_system, 
  wants_newsletter, 
  created_at, 
  next_payment_date
) VALUES (?, ?, ?, ?, 'monthly', 'active', ?, ?, NOW(), NOW() + INTERVAL '1 month')
```

#### Task 9: Генерация триггера для интеграционного сервиса
- **ID**: ST_RC_111
- **Название**: "Запись триггера 'subscription_created'"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платформа (Битрикс)
- **Lane**: 2.2
- **Входящие потоки**: ST_RC_110
- **Исходящие потоки**: (polling)
- **SQL**:
```sql
INSERT INTO integration_triggers (
  trigger_type, 
  entity_id, 
  status, 
  payload, 
  created_at
) VALUES ('subscription_created', ?, 'pending', ?, NOW())
```

#### Task 10: Обработка триггера интеграционным сервисом
- **ID**: ST_RC_120
- **Название**: "Получение триггера через polling"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.1 Обработка триггеров подписок
- **Входящие потоки**: (из Timer Event polling)
- **Исходящие потоки**: ST_RC_121

#### Task 11: Валидация данных подписки
- **ID**: ST_RC_121
- **Название**: "Валидация email и суммы"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.2 Валидация и бизнес-правила
- **Входящие потоки**: ST_RC_120
- **Исходящие потоки**: GW_RC_100
- **Проверки**:
  - Email валиден (RFC 5322)
  - Сумма > 0
  - Частота валидна (monthly)
  - subscription_id уникален

#### Gateway: Данные валидны?
- **ID**: GW_RC_100
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Интеграционный сервис
- **Lane**: 3.2
- **Входящие потоки**: ST_RC_121
- **Исходящие потоки**: ST_RC_122 (да), ST_RC_130 (нет - логирование)

#### Task 12: Сохранение в БД интеграционного сервиса
- **ID**: ST_RC_122
- **Название**: "Сохранение подписки в localstorage"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.1
- **Входящие потоки**: GW_RC_100 (да)
- **Исходящие потоки**: ST_RC_123
- **SQL** (в БД интеграционного сервиса):
```sql
INSERT INTO subscriptions_integration (
  subscription_id,
  donor_email,
  amount,
  status,
  payment_count,
  failed_attempts,
  wants_newsletter,
  created_at,
  last_payment_date,
  next_payment_date
) VALUES (?, ?, ?, 'active', 0, 0, ?, NOW(), NULL, NOW() + INTERVAL '1 month')
```

#### Task 13: Добавление в список рассылки Unisender (если согласие)
- **ID**: ST_RC_123
- **Название**: "Добавление email в список рассылки (ФТ-020)"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.3 Управление рекуррентными платежами
- **Входящие потоки**: ST_RC_122
- **Исходящие потоки**: GW_RC_101
- **Условие**: `wants_newsletter == true`
- **API**: `POST https://go1.unisender.ru/ru/bulk/api/v1.0/subscribe`
- **Payload**:
```json
{
  "list_id": 123456,
  "fields": {
    "email": "donor@example.com",
    "Name": "Иван Иванов"
  },
  "double_optin": 0
}
```

#### Gateway: Добавить в рассылку?
- **ID**: GW_RC_101
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Интеграционный сервис
- **Lane**: 3.3
- **Входящие потоки**: ST_RC_123
- **Исходящие потоки**: ST_RC_124 (да), ST_RC_125 (нет)

#### Task 14: Формирование письма о подтверждении подписки
- **ID**: ST_RC_124
- **Название**: "Подготовка email"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.3
- **Входящие потоки**: GW_RC_101 (да) или ST_RC_125
- **Исходящие потоки**: ST_RC_126
- **Шаблон**: `subscription_confirmation`
- **Переменные**: donor_name, amount, start_date, interval

#### Task 15: Отправка письма через Unisender Go
- **ID**: ST_RC_126
- **Название**: "POST /email/send"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.3
- **Входящие потоки**: ST_RC_124
- **Исходящие потоки**: GW_RC_102
- **API**: `POST https://go1.unisender.ru/ru/transactional/api/v1/email/send`
- **Аналогично**: Стандартный retry механизм

#### Gateway: Email отправлен?
- **ID**: GW_RC_102
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Интеграционный сервис
- **Lane**: 3.3
- **Входящие потоки**: ST_RC_126
- **Исходящие потоки**: ST_RC_127 (успех), ST_RC_128 (ошибка)

#### Task 16: Логирование успеха
- **ID**: ST_RC_127
- **Название**: "Логирование успеха"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.5 Логирование
- **Входящие потоки**: GW_RC_102 (успех)
- **Исходящие потоки**: EE_RC_100

#### Task 17: Логирование ошибки
- **ID**: ST_RC_128
- **Название**: "Логирование ошибки"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.5
- **Входящие потоки**: GW_RC_102 (ошибка)
- **Исходящие потоки**: EE_RC_101

#### End Events
- **ID**: EE_RC_100 (успех), EE_RC_101 (ошибка)
- **Тип**: None End Event / Error End Event
- **Pool**: Интеграционный сервис
- **Lane**: 3.5

---

### Часть 2: Ежемесячное списание (Рекуррентный платеж)

#### Timer Event: Ежемесячное списание
- **ID**: TE_RC_200
- **Название**: "Наступление даты следующего платежа"
- **Тип**: Timer Start Event
- **Pool**: Платежные системы
- **Lane**: 5.1
- **Периодичность**: Ежедневно (проверка всех подписок с next_payment_date <= TODAY)
- **Выражение**: `R/P1D` (каждый день)

#### Task 18: Получение подписок для списания
- **ID**: ST_RC_200
- **Название**: "Запрос подписок на списание"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платежные системы
- **Lane**: 5.1
- **Входящие потоки**: TE_RC_200
- **Исходящие потоки**: ST_RC_201
- **SQL** (в системе платежной системы или callback от неё):
  - Получить все подписки со статусом 'active' и next_payment_date <= TODAY

#### Task 19: Выполнение списания
- **ID**: ST_RC_201
- **Название**: "Обработка рекуррентного платежа"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платежные системы
- **Lane**: 5.1
- **Входящие потоки**: ST_RC_200
- **Исходящие потоки**: GW_RC_200
- **API** (CloudPayments): `POST /api/v3/subscriptions/{subscription_id}/process-payment`
- **Описание**: Попытка списания средств с привязанной карты

#### Gateway: Платеж успешен?
- **ID**: GW_RC_200
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Платежные системы
- **Lane**: 5.1
- **Входящие потоки**: ST_RC_201
- **Исходящие потоки**: ST_RC_202 (успех), ST_RC_203 (ошибка)
- **Условие (успех)**: `response.status == 'succeeded'`
- **Условие (ошибка)**: `response.status == 'declined' || response.status == 'error'`

#### Task 20a: Callback успешного платежа
- **ID**: ST_RC_202
- **Название**: "Отправка callback success"
- **Тип**: Send Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платежные системы
- **Lane**: 5.1
- **Входящие потоки**: GW_RC_200 (успех)
- **Исходящие потоки**: MSG_RC_200
- **Payload**:
```json
{
  "status": "success",
  "subscription_id": "SUB123456",
  "transaction_id": "TXN789...",
  "amount": 5000.00,
  "charged_date": "2025-12-01T10:00:00Z",
  "next_charge_date": "2026-01-01T10:00:00Z"
}
```

#### Task 20b: Callback ошибки платежа
- **ID**: ST_RC_203
- **Название**: "Отправка callback fail"
- **Тип**: Send Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платежные системы
- **Lane**: 5.2 Обработка ошибок платежей
- **Входящие потоки**: GW_RC_200 (ошибка)
- **Исходящие потоки**: MSG_RC_201
- **Payload**:
```json
{
  "status": "failed",
  "subscription_id": "SUB123456",
  "error_code": "insufficient_funds",
  "error_message": "Недостаточно средств на счете",
  "attempt": 1,
  "next_attempt": "2025-12-04T10:00:00Z"
}
```

#### Message Flow 3 (успех)
- **ID**: MSG_RC_200
- **От**: ST_RC_202 (Pool: Платежные системы)
- **К**: RT_RC_200 (Pool: Платформа Битрикс)

#### Message Flow 4 (ошибка)
- **ID**: MSG_RC_201
- **От**: ST_RC_203 (Pool: Платежные системы)
- **С**: RT_RC_200 (Pool: Платформа Битрикс)

#### Task 21: Получение результата платежа
- **ID**: RT_RC_200
- **Название**: "Получение callback результата"
- **Тип**: Receive Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платформа (Битрикс)
- **Lane**: 2.2
- **Входящие потоки**: MSG_RC_200, MSG_RC_201
- **Исходящие потоки**: ST_RC_210

#### Task 22: Сохранение результата платежа
- **ID**: ST_RC_210
- **Название**: "Сохранение транзакции"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платформа (Битрикс)
- **Lane**: 2.1
- **Входящие потоки**: RT_RC_200
- **Исходящие потоки**: ST_RC_211
- **SQL**:
```sql
INSERT INTO recurring_transactions (
  subscription_id,
  transaction_id,
  amount,
  status,
  error_code,
  error_message,
  charged_date,
  created_at
) VALUES (?, ?, ?, ?, ?, ?, NOW(), NOW())
```

#### Task 23: Обновление данных подписки
- **ID**: ST_RC_211
- **Название**: "Обновление информации подписки"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платформа (Битрикс)
- **Lane**: 2.1
- **Входящие потоки**: ST_RC_210
- **Исходящие потоки**: GW_RC_210
- **SQL** (при успехе):
```sql
UPDATE subscriptions 
SET 
  last_payment_date = NOW(),
  next_payment_date = NOW() + INTERVAL '1 month',
  status = 'active'
WHERE subscription_id = ?
```
- **SQL** (при ошибке):
```sql
UPDATE subscriptions 
SET 
  failed_attempts = failed_attempts + 1,
  last_error = ?,
  status = CASE 
    WHEN failed_attempts >= 4 THEN 'failed'
    ELSE 'active'
  END,
  next_payment_date = NOW() + INTERVAL '3 days'
WHERE subscription_id = ?
```

#### Gateway: Платеж успешен?
- **ID**: GW_RC_210
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Платформа (Битрикс)
- **Lane**: 2.1
- **Входящие потоки**: ST_RC_211
- **Исходящие потоки**: ST_RC_220 (успех), ST_RC_230 (ошибка)
- **Условие**: `transaction_status == 'success'`

---

### Часть 2a: Успешный платеж

#### Task 24: Генерация триггера успешного платежа
- **ID**: ST_RC_220
- **Название**: "Запись триггера 'recurring_payment_success'"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платформа (Битрикс)
- **Lane**: 2.2
- **Входящие потоки**: GW_RC_210 (успех)
- **Исходящие потоки**: (polling интеграционным сервисом)
- **SQL**:
```sql
INSERT INTO integration_triggers (
  trigger_type,
  entity_id,
  status,
  payload,
  created_at
) VALUES ('recurring_payment_success', ?, 'pending', ?, NOW())
```

#### Task 25: Обработка триггера успешного платежа
- **ID**: ST_RC_240
- **Название**: "Получение триггера"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.1
- **Входящие потоки**: (из polling)
- **Исходящие потоки**: ST_RC_241

#### Task 26: Проверка номера платежа (ФТ-012)
- **ID**: ST_RC_241
- **Название**: "Проверка: 12-й платеж?"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.2
- **Входящие потоки**: ST_RC_240
- **Исходящие потоки**: GW_RC_220
- **SQL**:
```sql
SELECT COUNT(*) FROM recurring_transactions 
WHERE subscription_id = ? AND status = 'success'
```

#### Gateway: Это 12-й платеж?
- **ID**: GW_RC_220
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Интеграционный сервис
- **Lane**: 3.2
- **Входящие потоки**: ST_RC_241
- **Исходящие потоки**: ST_RC_242 (да - ФТ-012), ST_RC_243 (нет - обычная благодарность)

#### Task 27a: Формирование письма за 12 месяцев
- **ID**: ST_RC_242
- **Название**: "Подготовка спец. письма (12 месяцев)"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.3
- **Входящие потоки**: GW_RC_220 (да)
- **Исходящие потоки**: ST_RC_245
- **Шаблон**: `subscription_anniversary_12months`
- **Переменные**: donor_name, total_amount, 12*amount

#### Task 27b: Формирование обычного письма
- **ID**: ST_RC_243
- **Название**: "Подготовка обычного письма благодарности"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.3
- **Входящие потоки**: GW_RC_220 (нет)
- **Исходящие потоки**: ST_RC_245
- **Шаблон**: `recurring_payment_thanks`
- **Переменные**: donor_name, amount, transaction_date

#### Task 28: Отправка письма
- **ID**: ST_RC_245
- **Название**: "POST /email/send"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.3
- **Входящие потоки**: ST_RC_242, ST_RC_243
- **Исходящие потоки**: ST_RC_246

#### Task 29: Логирование
- **ID**: ST_RC_246
- **Название**: "Логирование успешной отправки"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.5
- **Входящие потоки**: ST_RC_245
- **Исходящие потоки**: EE_RC_200

#### End Event (успех)
- **ID**: EE_RC_200
- **Тип**: None End Event
- **Pool**: Интеграционный сервис
- **Lane**: 3.5

---

### Часть 2b: Неудачный платеж

#### Task 30: Генерация триггера ошибки платежа
- **ID**: ST_RC_230
- **Название**: "Запись триггера 'recurring_payment_failed'"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платформа (Битрикс)
- **Lane**: 2.2
- **Входящие потоки**: GW_RC_210 (ошибка)
- **Исходящие потоки**: (polling)

#### Task 31: Обработка триггера ошибки
- **ID**: ST_RC_250
- **Название**: "Получение триггера ошибки"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.1
- **Входящие потоки**: (из polling)
- **Исходящие потоки**: ST_RC_251

#### Task 32: Определение уровня эскалации
- **ID**: ST_RC_251
- **Название**: "Проверка количества неудачных попыток"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.4 Эскалация и автоматическая отмена
- **Входящие потоки**: ST_RC_250
- **Исходящие потоки**: GW_RC_230
- **SQL**:
```sql
SELECT failed_attempts, last_error FROM subscriptions 
WHERE subscription_id = ?
```

#### Gateway: Уровень эскалации?
- **ID**: GW_RC_230
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Интеграционный сервис
- **Lane**: 3.4
- **Входящие потоки**: ST_RC_251
- **Исходящие потоки**: 
  - ST_RC_260 (1-я попытка): failed_attempts == 1
  - ST_RC_270 (2-3-я попытки): 1 < failed_attempts < 4
  - ST_RC_280 (5-я попытка - автоотмена): failed_attempts >= 4

#### Task 33a: Письмо при 1-й ошибке (ФТ-010)
- **ID**: ST_RC_260
- **Название**: "Подготовка письма об ошибке"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.4
- **Входящие потоки**: GW_RC_230 (1-я попытка)
- **Исходящие потоки**: ST_RC_261
- **Шаблон**: `recurring_payment_failed_attempt1`
- **ФТ**: ФТ-010 "Письмо при неудачном списании"
- **Переменные**: donor_name, error_description, next_attempt_date

#### Task 33b: Письмо при 2-3 ошибках (Предупреждение)
- **ID**: ST_RC_270
- **Название**: "Подготовка письма предупреждения"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.4
- **Входящие потоки**: GW_RC_230 (2-3-я попытки)
- **Исходящие потоки**: ST_RC_271
- **Шаблон**: `recurring_payment_failed_warning`
- **Переменные**: donor_name, error_code, attempts_count, update_card_link

#### Task 33c: Письмо при 5-й ошибке (Отмена подписки)
- **ID**: ST_RC_280
- **Название**: "Подготовка письма отмены подписки"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.4
- **Входящие потоки**: GW_RC_230 (5-я попытка)
- **Исходящие потоки**: ST_RC_281
- **Шаблон**: `recurring_payment_subscription_cancelled`
- **Переменные**: donor_name, reactivation_link

#### Task 34a: Отправка письма (попытки 1-3)
- **ID**: ST_RC_261
- **Название**: "Отправка письма об ошибке"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.3
- **Входящие потоки**: ST_RC_260, ST_RC_271
- **Исходящие потоки**: ST_RC_262

#### Task 34b: Отправка письма отмены
- **ID**: ST_RC_281
- **Название**: "Отправка письма об отмене подписки"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.3
- **Входящие потоки**: ST_RC_280
- **Исходящие потоки**: ST_RC_282

#### Task 35: Автоматическая отмена подписки
- **ID**: ST_RC_282
- **Название**: "Отмена подписки в БД"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.4
- **Входящие потоки**: ST_RC_281
- **Исходящие потоки**: ST_RC_283
- **SQL**:
```sql
UPDATE subscriptions 
SET 
  status = 'cancelled',
  cancelled_at = NOW(),
  cancellation_reason = 'max_failed_attempts'
WHERE subscription_id = ?
```

#### Task 36: Запрос отмены в платежной системе
- **ID**: ST_RC_283
- **Название**: "API запрос отмены подписки"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.4
- **Входящие потоки**: ST_RC_282
- **Исходящие потоки**: ST_RC_290
- **API** (CloudPayments): `DELETE /api/v3/subscriptions/{subscription_id}`

#### Task 37: Логирование
- **ID**: ST_RC_262
- **Название**: "Логирование отправки"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.5
- **Входящие потоки**: ST_RC_261
- **Исходящие потоки**: ST_RC_290

#### Task 38: Финализация
- **ID**: ST_RC_290
- **Название**: "Завершение обработки"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.5
- **Входящие потоки**: ST_RC_262, ST_RC_283
- **Исходящие потоки**: EE_RC_201

#### End Event (ошибка)
- **ID**: EE_RC_201
- **Тип**: None End Event
- **Pool**: Интеграционный сервис
- **Lane**: 3.5

---

### Часть 3: Ручная отмена подписки

#### Start Event
- **ID**: SE_RC_300
- **Название**: "Благотворитель отменяет подписку"
- **Тип**: None Start Event
- **Pool**: Благотворитель
- **Lane**: 1.2 Управление подпиской

#### Task 39: Нажатие кнопки отмены
- **ID**: UT_RC_300
- **Название**: "Отмена подписки"
- **Тип**: User Task
- **Pool**: Благотворитель
- **Lane**: 1.2
- **Входящие потоки**: SE_RC_300
- **Исходящие потоки**: ST_RC_300

#### Task 40: Отправка запроса на отмену
- **ID**: ST_RC_300
- **Название**: "Запрос отмены подписки"
- **Тип**: Send Task
- **Pool**: Благотворитель
- **Lane**: 1.2
- **Входящие потоки**: UT_RC_300
- **Исходящие потоки**: MSG_RC_300

#### Message Flow
- **ID**: MSG_RC_300
- **От**: ST_RC_300 (Pool: Благотворитель)
- **К**: ST_RC_310 (Pool: Платформа Битрикс)

#### Task 41: Обновление статуса подписки
- **ID**: ST_RC_310
- **Название**: "Изменение статуса на 'cancelled'"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платформа (Битрикс)
- **Lane**: 2.1
- **Входящие потоки**: MSG_RC_300
- **Исходящие потоки**: ST_RC_311
- **SQL**:
```sql
UPDATE subscriptions 
SET 
  status = 'cancelled',
  cancelled_at = NOW(),
  cancellation_reason = 'donor_request'
WHERE subscription_id = ?
```

#### Task 42: Генерация триггера отмены
- **ID**: ST_RC_311
- **Название**: "Запись триггера 'subscription_cancelled'"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платформа (Битрикс)
- **Lane**: 2.2
- **Входящие потоки**: ST_RC_310
- **Исходящие потоки**: (polling)

#### Task 43: Обработка триггера отмены
- **ID**: ST_RC_320
- **Название**: "Получение триггера отмены"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.1
- **Входящие потоки**: (из polling)
- **Исходящие потоки**: ST_RC_321

#### Task 44: Добавление email в suppression list
- **ID**: ST_RC_321
- **Название**: "Добавление в suppression list Unisender"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.3
- **Входящие потоки**: ST_RC_320
- **Исходящие потоки**: ST_RC_322
- **API**: `POST https://go1.unisender.ru/ru/transactional/api/v1/suppression/set`
- **Payload**:
```json
{
  "emails": ["donor@example.com"],
  "list_id": 123456,
  "suppress": true
}
```

#### Task 45: Формирование прощального письма
- **ID**: ST_RC_322
- **Название**: "Подготовка прощального письма"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.3
- **Входящие потоки**: ST_RC_321
- **Исходящие потоки**: ST_RC_323
- **Шаблон**: `subscription_farewell_with_reactivation`
- **Переменные**: donor_name, reactivation_link

#### Task 46: Отправка прощального письма
- **ID**: ST_RC_323
- **Название**: "Отправка письма"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.3
- **Входящие потоки**: ST_RC_322
- **Исходящие потоки**: ST_RC_330

#### Task 47: Отмена подписки в платежной системе
- **ID**: ST_RC_330
- **Название**: "API запрос отмены"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.4
- **Входящие потоки**: ST_RC_323
- **Исходящие потоки**: ST_RC_331

#### Task 48: Логирование
- **ID**: ST_RC_331
- **Название**: "Логирование отмены"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 3.5
- **Входящие потоки**: ST_RC_330
- **Исходящие потоки**: MSG_RC_301

#### Message Flow
- **ID**: MSG_RC_301
- **От**: ST_RC_331 (Pool: Интеграционный сервис)
- **К**: RT_RC_300 (Pool: Благотворитель)

#### Task 49: Получение подтверждения
- **ID**: RT_RC_300
- **Название**: "Получение прощального письма"
- **Тип**: Receive Task
- **Pool**: Благотворитель
- **Lane**: 1.3 Получение уведомлений
- **Входящие потоки**: MSG_RC_301
- **Исходящие потоки**: EE_RC_300

#### End Event
- **ID**: EE_RC_300
- **Тип**: None End Event
- **Pool**: Благотворитель
- **Lane**: 1.3

---

## Таблица соответствия задач и функциональных требований

| Task ID | Task Name | ФТ | Описание |
|---------|-----------|-----|---------|
| UT_RC_102 | Чек-бокс согласия | ФТ-020 | Соглашение на рассылку |
| ST_RC_123 | Добавление в Unisender | ФТ-020 | Добавление в список рассылки |
| ST_RC_220 | Триггер успеха | ФТ-012 | Благодарность за 12 месяцев |
| ST_RC_260 | Письмо об ошибке | ФТ-010 | Письмо при неудачном списании |
| ST_RC_270 | Письмо предупреждения | ФТ-010 | Письмо при неудачном списании |
| ST_RC_282 | Автоотмена подписки | ФТ-011 | Логика отмены при ошибках |
| ST_RC_321 | Suppression list | ФТ-011 | Удаление из рассылки |

---

## SQL схема (основные таблицы)

```sql
-- Таблица подписок в БД интеграционного сервиса
CREATE TABLE subscriptions_integration (
  id SERIAL PRIMARY KEY,
  subscription_id VARCHAR(255) UNIQUE,
  donor_email VARCHAR(255),
  amount DECIMAL(10, 2),
  status ENUM('active', 'cancelled', 'failed') DEFAULT 'active',
  payment_count INT DEFAULT 0,
  failed_attempts INT DEFAULT 0,
  wants_newsletter BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_payment_date TIMESTAMP,
  next_payment_date TIMESTAMP,
  cancelled_at TIMESTAMP,
  last_error TEXT
);

-- Таблица рекуррентных транзакций
CREATE TABLE recurring_transactions (
  id SERIAL PRIMARY KEY,
  subscription_id VARCHAR(255),
  transaction_id VARCHAR(255),
  amount DECIMAL(10, 2),
  status ENUM('success', 'failed') DEFAULT 'failed',
  error_code VARCHAR(100),
  error_message TEXT,
  charged_date TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (subscription_id) REFERENCES subscriptions_integration(subscription_id)
);
```

---

## Timer Events (Периодичность)

| Event ID | Название | Периодичность | Назначение |
|----------|-----------|---|---|
| TE_RC_200 | Проверка дат платежей | Ежедневно (P1D) | Ежедневное списание |
| TE_100 | Polling БД Битрикс | Каждые 10 сек | Обработка триггеров |

---

## Примечания по реализации

### Retry механизм (для ошибок API)
- 1-я попытка: немедленно
- 2-я попытка: +1 секунда
- 3-я попытка: +2 секунды
- 4-я попытка: +4 секунды (максимум)

### Эскалация рекуррентных платежей
- 1-я ошибка: информационное письмо
- 2-3-я ошибка: письмо с предупреждением
- 4-5-я ошибка: автоматическая отмена подписки

### Таблицы Unisender Go
- list_id: ID основного списка рассылки (из конфигурации)
- Синхронизация: Добавление email при согласии (ФТ-020)

Эта диаграмма полностью описывает процесс рекуррентных платежей с учетом новых требований ФТ-020, ФТ-010, ФТ-011, ФТ-012.