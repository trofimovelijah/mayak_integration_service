# Анализ BPMN диаграмм и рекомендации по финализации

## Часть 1: Ошибки нотации BPMN в текущих диаграммах

### 📋 Диаграмма 1: Работа с Событиями (to-be-events.bpmn)

#### Выявленные ошибки нотации:

**1. Незавершённые потоки (Dangling flows)**
- ❌ **Проблема**: После задачи "Регистрация на платформе" есть ветвление (Gateway), но один из путей не имеет явного завершения перед объединением
- ✅ **Решение**: Все пути должны сходиться к одному объединяющему Gateway (XOR Join) перед следующей задачей или завершением
- 📍 **Локация**: Верхняя левая часть диаграммы

**2. Отсутствие явного End Event для некоторых путей**
- ❌ **Проблема**: Процесс создания события содержит несколько путей (одобрение/отклонение), но не все пути явно заканчиваются событием завершения
- ✅ **Решение**: Каждый путь в процессе должен завершиться Either или End Event или присоединиться к единому финальному концу
- 📍 **Локация**: Правая часть диаграммы (после Gateway "Событие прошло модерацию?")

**3. Message Flow без чёткого указания Source/Target**
- ❌ **Проблема**: Некоторые стрелки сообщений идут в "пусто" или не имеют чёткого Pool/Lane адреса назначения
- ✅ **Решение**: Каждый Message Flow должен иметь чёткие исходный и целевой элементы, обычно это события или граничные точки пула
- 📍 **Локация**: Коммуникации между пулом "Платформа" и "Интеграционный сервис"

**4. Отсутствие условий на некоторых Gateway**
- ❌ **Проблема**: Gateway "Прошла ли модерация?" имеет два выходящих потока, но условия (да/нет) не указаны явно
- ✅ **Решение**: На каждом Exclusive Gateway (XOR) явно указывать условия (Guard) для каждого потока
- 📍 **Локация**: Правая часть диаграммы

**5. Перепутанные типы Task**
- ❌ **Проблема**: "Отправка письма администратору" обозначена как User Task, но это должен быть Send Task
- ✅ **Решение**: 
  - Send Task = отправка сообщения внешнему участнику
  - Service Task = синхронный вызов сервиса
  - Manual Task = ручная работа человека вне системы
  - User Task = взаимодействие через UI системы
- 📍 **Локация**: Центральная часть диаграммы

**6. Отсутствие Timer Event для напоминаний**
- ❌ **Проблема**: Процесс содержит логику "напоминания" (ФТ-001, ФТ-021, ФТ-023), но Timer Events не используются
- ✅ **Решение**: Для отложенных действий использовать Intermediate Timer Events или Timer Start Events
- 📍 **Локация**: Всё не видно на диаграмме - нужно добавить подпроцесс

---

### 📋 Диаграмма 2: Работа с платежами (to-be-donation.bpmn)

#### Выявленные ошибки нотации:

**1. Множественные незавершённые потоки**
- ❌ **Проблема**: После Gateway "Платеж успешен?" есть два пути, но они не объединяются для формирования письма
- ✅ **Решение**: Использовать XOR Join Gateway для объединения успеха и ошибки перед единой логикой обработки
- 📍 **Локация**: Центр диаграммы (после платежной системы)

**2. Отсутствие Receive Task перед обработкой callback**
- ❌ **Проблема**: После отправки запроса платежной системе сразу идёт обработка, без явного получения callback
- ✅ **Решение**: Добавить явный Receive Task "Получить результат платежа" для чётности коммуникации
- 📍 **Локация**: Взаимодействие с платежной системой

**3. Отсутствие обработки ошибок валидации email**
- ❌ **Проблема**: Email благотворителя не валидируется перед отправкой письма
- ✅ **Решение**: Добавить Business Rule Task "Валидировать email (RFC 5322)" перед отправкой (ФТ-020, БП-005)
- 📍 **Локация**: Перед Service Task "Отправка письма"

**4. Отсутствие дедупликации**
- ❌ **Проблема**: Если платеж повторится, письмо будет отправлено дважды
- ✅ **Решение**: Добавить Business Rule Task "Проверить дубликат письма" (БП-006 - 24 часа)
- 📍 **Локация**: Перед формированием письма благодарности

**5. Retry механизм не показан явно**
- ❌ **Проблема**: Если Unisender вернёт 429 или 5xx, процесс не показывает обработку
- ✅ **Решение**: Добавить Gateway "API ошибка исправима?" и Intermediate Timer Event для retry
- 📍 **Локация**: После отправки письма через Unisender

**6. Отсутствие формирования письма первого пожертвования (ФТ-007)**
- ❌ **Проблема**: Нет Business Rule Task для определения "это первое пожертвование?"
- ✅ **Решение**: Добавить Gateway после валидации: "Первое пожертвование?" → разные шаблоны
- 📍 **Локация**: После Receive Task callback

**7. Нет обработки крупного пожертвования (ФТ-008)**
- ❌ **Проблема**: Пожертвования ≥50000₽ должны отправить другой шаблон (БП-010)
- ✅ **Решение**: Добавить Business Rule Task "Сумма >= 50000?" перед выбором шаблона
- 📍 **Локация**: После определения суммы

---

### 📋 Диаграмма 3: Работа с рекуррентными платежами (to-be-recurrent.bpmn)

#### Выявленные ошибки нотации:

**1. Циклические потоки без явного Timer Event**
- ❌ **Проблема**: Ежемесячное списание показано без Timer Start Event, запускающего этот процесс
- ✅ **Решение**: Добавить Timer Start Event "Ежедневное расписание платежей" (каждые 24 часа)
- 📍 **Локация**: Начало подпроцесса ежемесячного списания

**2. Отсутствие явного Gateway объединения путей успеха/ошибки**
- ❌ **Проблема**: После Gateway "Платеж успешен?" пути разходятся и не видно, где они объединяются
- ✅ **Решение**: Добавить XOR Join перед логированием
- 📍 **Локация**: После разветвления успеха/ошибки

**3. Отсутствие подпроцесса для эскалации ошибок**
- ❌ **Проблема**: Логика обработки 1-й, 2-3-й, 4-5-й ошибок не видна - нужен отдельный подпроцесс
- ✅ **Решение**: Создать подпроцесс "Обработка неудачного платежа" с внутренней логикой эскалации
- 📍 **Локация**: Весь путь ошибки (путь "нет")

**4. Отсутствие Gateway "Это 12-й платеж?" для благодарности (ФТ-012)**
- ❌ **Проблема**: После успешного платежа нет проверки количества платежей
- ✅ **Решение**: Добавить Business Rule Task "payment_count == 12?" → выбор шаблона
- 📍 **Локация**: После успешного платежа

**5. Отсутствие Gateway объединения разных путей благодарности**
- ❌ **Проблема**: Обычная благодарность (ФТ-005) и благодарность за год (ФТ-012) идут разными путями
- ✅ **Решение**: Использовать XOR Join перед общей отправкой письма
- 📍 **Локация**: После выбора шаблона

**6. Нет явного Receive Task для получения callback платежной системы**
- ❌ **Проблема**: После вызова API платежной системы сразу обработка результата
- ✅ **Решение**: Добавить явный Receive Task для асинхронного получения callback
- 📍 **Локация**: После отправки запроса платежной системе

**7. Отсутствие Timer Event между retry попытками**
- ❌ **Проблема**: Если ошибка API Unisender, нет явного указания задержки перед повтором
- ✅ **Решение**: Добавить Intermediate Timer Event с экспоненциальной задержкой (PT1S, PT2S, PT4S)
- 📍 **Локация**: В пути обработки ошибки отправки

**8. Путь отмены подписки не объединён с основным потоком**
- ❌ **Проблема**: После отмены подписки при 5-й ошибке нет явного завершения процесса
- ✅ **Решение**: Все пути должны сходиться к единому End Event
- 📍 **Локация**: Конец процесса

---

## Часть 2: Рекомендации по созданию подпроцессов (Subprocesses)

### 🔄 Стратегия модульности

#### Подпроцесс 1: "Валидация и подготовка данных"

**Вход**: Объект с данными (email, имя, сумма)
**Выход**: Валидированные данные или ошибка

**Внутренняя логика**:
```
START 
  ↓
[Валидировать email (RFC 5322)]
  ↓ Ошибка?
Gateway "Email валиден?" → NO → END Event (Error)
  ↓ YES
[Валидировать сумму > 0]
  ↓ Ошибка?
Gateway "Сумма валидна?" → NO → END Event (Error)
  ↓ YES
[Проверить дубликат в течение 24ч]
  ↓ Найден?
Gateway "Дубликат?" → YES → END Event (Completed) "Пропусти"
  ↓ NO
END Event (Completed) → Выход валидированные данные
```

**Входные параметры**:
- `donor_email: string`
- `donor_name: string`
- `amount: decimal`
- `event_type: string` (donation_received, event_created и т.д.)

**Выходные параметры**:
- `is_valid: boolean`
- `is_duplicate: boolean`
- `validated_data: object`

**Использование**: Используется в процессах 2 и 3 (пожертвование и рекуррентные платежи)

**Как подключать в диаграмму**:
```
[Получить триггер] → [Подпроцесс: Валидация] → Gateway "Результат?"
                                        ↓ OK
                                    [Отправить письмо]
                                        ↓ Error/Duplicate
                                    [Логирование]
```

---

#### Подпроцесс 2: "Отправка письма через Unisender"

**Вход**: Объект письма (email, template_id, переменные)
**Выход**: Результат отправки (успех/ошибка)

**Внутренняя логика**:
```
START (объект письма)
  ↓
[Подготовить JSON payload]
  ↓
[POST запрос к Unisender Go API]
  ↓
Gateway "API ошибка?" 
  ├─ YES (200 OK) → [Логирование: sent] → END Event (Completed)
  ├─ YES (429/5xx) → [Добавить в retry_queue] → Timer Event (2^n сек) → Повтор запроса
  └─ NO (4xx кроме 429) → [Логирование: failed] → END Event (Error)
```

**Входные параметры**:
- `recipient_email: string`
- `template_id: string`
- `substitutions: object` (переменные для шаблона)
- `retry_count: int` (по умолчанию 0)

**Выходные параметры**:
- `message_id: string` (при успехе)
- `status: enum` (sent, pending, failed)
- `error_code: string` (при ошибке)

**Использование**: Для всех Email отправок (ФТ-001 - ФТ-027)

**Как подключать в диаграмму**:
```
[Выбрать шаблон письма] → [Подпроцесс: Отправка письма] → [Ждём результата]
                                        ↓ Успех
                                    [Обновить статистику]
                                        ↓ Ошибка с retry
                                    [Добавить в очередь retry]
```

---

#### Подпроцесс 3: "Выполнить регистрацию на Платформе" (уже существует)

**Дополнение**: Нужно явно указать входы/выходы

**Входные параметры**:
- `email: string`
- `name: string`
- `phone: string` (опционально)
- `birthdate: date` (опционально)

**Выходные параметры**:
- `user_id: string`
- `registration_successful: boolean`
- `error_message: string` (если ошибка)

**Текущее использование**: В диаграмме событий (путь новой регистрации)

---

#### Подпроцесс 4: "Обработка результата платежа" (НОВЫЙ)

**Вход**: Callback от платежной системы (success/fail)
**Выход**: Сохранённые данные, триггеры, письма

**Внутренняя логика**:
```
START (callback платежной системы)
  ↓
Gateway "Платеж успешен?"
  ├─ YES → [Сохранить в БД: success]
  │          ↓
  │       [Генерировать триггер: payment_success]
  │          ↓
  │       [Определить шаблон письма]
  │          ↓
  │       END Event (Completed)
  │
  └─ NO → [Сохранить в БД: failed]
           ↓
        [Увеличить счётчик ошибок]
           ↓
        Gateway "Это 5-я ошибка?"
           ├─ YES → [Отменить подписку] → END Event (Subscription Cancelled)
           └─ NO → [Генерировать триггер: payment_error] → END Event (Completed)
```

**Входные параметры**:
- `payment_status: enum` (success, failed)
- `transaction_id: string`
- `amount: decimal`
- `error_code: string` (при ошибке)

**Выходные параметры**:
- `saved_transaction: object`
- `trigger_generated: string`
- `subscription_status: enum` (если изменился)

**Использование**: В процессах пожертвований и рекуррентных платежей

---

#### Подпроцесс 5: "Выбрать шаблон письма" (НОВЫЙ)

**Вход**: Контекст события (тип, сумма, количество платежей и т.д.)
**Выход**: ID шаблона и переменные для подстановки

**Внутренняя логика**:
```
START (контекст события)
  ↓
Gateway "Тип события?"
  ├─ donation_received → Gateway "Сумма?"
  │                       ├─ < 1000 → template = "donation_thanks_basic"
  │                       ├─ 1000-50000 → template = "donation_thanks_extended"
  │                       └─ >= 50000 → template = "donation_thanks_vip"
  │
  ├─ event_created → template = "event_created_notification"
  ├─ event_rejected → template = "event_rejected_with_reason"
  ├─ payment_success_12m → template = "subscription_anniversary_12months"
  ├─ payment_failed → Gateway "Попытка?"
  │                     ├─ 1 → template = "payment_failed_attempt1"
  │                     ├─ 2-3 → template = "payment_failed_warning"
  │                     └─ 5 → template = "subscription_cancelled"
  │
  └─ ... (остальные типы)

END Event (Completed) с выходом (template_id, substitutions)
```

**Входные параметры**:
- `event_type: string`
- `event_context: object` (amount, payment_count, failure_count и т.д.)
- `recipient_type: enum` (user, donor, admin)

**Выходные параметры**:
- `template_id: string`
- `substitutions: object` (для WYSIWYG редактора)
- `priority: enum` (transactional, marketing)

**Использование**: Перед каждой отправкой письма

---

### 📐 Правила соединения подпроцессов в диаграмму

#### Правило 1: Входная точка

```
[Предыдущая задача] 
    ↓
[Подпроцесс] (обычно обозначается как □ с плюсиком внизу)
    ↓ (Sequence Flow с меткой "call activity")
[Следующая задача]
```

**В Camunda Modeler**:
- Выбрать элемент "Call Activity" (не Simple Subprocess!)
- Указать `calledElement = "subprocess_name_from_id"`
- Связать входные переменные через mapping

#### Правило 2: Выходная точка

```
Подпроцесс имеет несколько возможных END Event:
  - END Event (завершение успешно)
  - END Event (Error) (завершение с ошибкой)
  - END Event (Cancel) (отмена)

Из каждого END Event выходит отдельный Sequence Flow:

[Подпроцесс]
    ├─ (success) → [Следующая задача 1]
    ├─ (error) → [Обработка ошибки]
    └─ (cancel) → [Отмена процесса]
```

**ВАЖНО**: Использовать Boundary Events на подпроцессе для перехвата ошибок:

```
┌─────────────────────┐
│  [Подпроцесс]       │
│                     │ ← Boundary Error Event (красный круг)
│   (call activity)   │
└─────────────────────┘
     ↓              ↓
  Успех         Ошибка
```

#### Правило 3: Переменные и Data Association

**Входящие данные** (Input Mapping):
```
task.inputMapping:
  - recipient_email ← variable("donor_email")
  - template_id ← variable("selected_template")
  - substitutions ← variable("letter_vars")
```

**Исходящие данные** (Output Mapping):
```
task.outputMapping:
  - message_id ← variable("sent_message_id")
  - send_status ← variable("status")
  - error_info ← variable("error_code")
```

#### Правило 4: Объединение путей после подпроцесса

```
Если подпроцесс может завершиться несколькими способами:

[Подпроцесс: Отправка письма]
    ├─ SUCCESS → [Процесс: success_end]
    │               ↓
    │            Gateway XOR (Join)
    │               ↑
    └─ ERROR → [Логирование ошибки]

(Join Gateway объединяет оба пути в один)
```

---

## Часть 3: Диаграмма для Администратора (Новая)

### 🎯 Архитектура диаграммы "Администратор"

**Назначение**: Показать все взаимодействия администратора с системой, включая:
- Модерацию событий
- Просмотр статистики платежей
- Управление шаблонами писем
- Переотправку неудачных писем
- Мониторинг здоровья системы

**Уровень детализации**: 
- ✅ Pool "Администратор" - максимум детализации (все действия)
- ⚠️  Другие Pools - минимум (только точки интеграции)

---

### 📋 Структура диаграммы администратора

```
TITLE: ADMIN-PANEL: Работа Администратора с Платформой

POOLS:
1. Администратор (главный, максимальная детализация)
   ├─ Lane 1.1: Модерация событий
   ├─ Lane 1.2: Просмотр статистики
   ├─ Lane 1.3: Управление коммуникациями
   ├─ Lane 1.4: Ручные операции
   └─ Lane 1.5: Мониторинг системы

2. Админ-панель (UI)
   └─ Lane 2.1: Backend API

3. Платформа (Битрикс)
   ├─ Lane 3.1: База данных
   └─ Lane 3.2: Уведомления

4. Интеграционный сервис
   └─ Lane 4.1: Обработка

5. Unisender Go (Email)
   └─ Lane 5.1: Отправка

6. Платежные системы
   └─ Lane 6.1: Процессинг
```

---

### 🔄 Основные процессы администратора

#### Процесс 1: Модерация событий (ФТ-024, ФТ-025, ФТ-026)

```
START: Администратор открывает админ-панель

[Аутентификация в системе]
    ↓
[Загрузка дашборда]
    ├─ Количество событий на модерации: N
    ├─ Количество новых пожертвований: M
    ├─ Статистика коммуникаций
    └─ Статус здоровья системы

    ↓
[Переход в раздел "Модерация событий"]
    ↓
[Загрузка списка событий со статусом "pending"]
    ├─ Фильтр по дате
    ├─ Фильтр по названию
    └─ Поиск

    ↓
[Выбор события для проверки]
    ↓
[Просмотр деталей события]
    ├─ Название, описание, целевая сумма
    ├─ Загруженные изображения
    ├─ Информация создателя
    └─ История изменений

    ↓
[Проверка на соответствие требованиям]
    ├─ Нет мата в тексте?
    ├─ Изображения корректны?
    ├─ Название не дублируется?
    └─ Цель соответствует фонду?

    ↓
DECISION GATEWAY: "Событие соответствует?"
    
    ├─ YES (Одобрить):
    │    [Нажать кнопку "Одобрить"]
    │        ↓
    │    MESSAGE to Platform (Битрикс):
    │    "UPDATE events SET status = 'published'"
    │        ↓
    │    TRIGGER to Integration Service:
    │    "event_approved" → ФТ-025 письмо пользователю
    │        ↓
    │    Platform sends to Unisender:
    │    "Отправить письмо: event_approved"
    │        ↓
    │    [Получить статус отправки]
    │        ↓
    │    [Отобразить: "✓ Событие одобрено"]
    │
    └─ NO (Отклонить):
         [Нажать кнопку "Отклонить"]
             ↓
         [Выбрать причину отклонения из выпадающего списка]
         (или ввести собственную причину)
             ↓
         MESSAGE to Platform:
         "UPDATE events SET status = 'rejected', reason = ...'"
             ↓
         TRIGGER to Integration Service:
         "event_rejected" + reason → ФТ-026 письмо с причиной
             ↓
         Platform sends to Unisender:
         "Отправить письмо: event_rejected_with_reason"
             ↓
         [Получить статус отправки]
             ↓
         [Отобразить: "✓ Событие отклонено"]

    ↓
[Вернуться к списку событий] ← LOOP
    ↓
DECISION: "Есть ещё события?"
    ├─ YES → Повторить для следующего события
    └─ NO → END
```

---

#### Процесс 2: Просмотр статистики коммуникаций (ФТ-013-017)

```
START: Администратор входит в раздел "Статистика"

    ↓
[Загрузить отчёт за период]
    ├─ Фильтр: Дата начала, дата конца
    ├─ Фильтр: Тип письма (все/ФТ-001/ФТ-005 и т.д.)
    └─ Кнопка "Применить фильтр"

    ↓
API REQUEST to Integration Service:
Query к БД + API к Unisender Go (event dump)
    ├─ SELECT COUNT(*) FROM processing_logs WHERE created_at BETWEEN ...
    ├─ SELECT COUNT(*) FROM email_statistics WHERE status = 'delivered'
    ├─ SELECT COUNT(*) FROM email_statistics WHERE opened = true
    ├─ SELECT COUNT(*) FROM email_statistics WHERE clicked = true
    └─ Расчёт: OR%, DR%, CTR%, CTOR%

    ↓
[Отображение дашборда со статистикой]
    ├─ Карточка: Всего отправлено: N писем
    ├─ Карточка: Доставлено: N, Процент: DR%
    ├─ Карточка: Открыто: N, Процент: OR%
    ├─ Карточка: Кликнуто: N, Процент: CTR%
    ├─ Карточка: Click-to-Open: CTOR%
    ├─ Карточка: Ошибок: N, Процент: Error%
    └─ График: Тренд доставки по дням

    ↓
[Экспорт отчёта]
    ├─ Кнопка "Скачать PDF"
    ├─ Кнопка "Скачать CSV"
    └─ Кнопка "Отправить по email"

    ↓
DECISION: "Уточнить статистику?"
    ├─ YES → Вернуться к фильтрам и повторить
    └─ NO → END
```

---

#### Процесс 3: Управление шаблонами писем (ФТ-018)

```
START: Администратор входит в раздел "Шаблоны писем"

    ↓
[Загрузить список шаблонов]
    ├─ ФТ-001: Напоминание о подтверждении почты
    ├─ ФТ-005: Благодарность за пожертвование (basic, extended, vip)
    ├─ ФТ-010: Письмо при неудачном списании
    ├─ ФТ-024: Событие на модерации
    ├─ ФТ-025: Событие одобрено
    ├─ ФТ-026: Событие отклонено
    └─ ... (итого 20+ шаблонов)

    ↓
[Выбрать шаблон для редактирования]
    ↓
[Открыть редактор шаблона]
    ├─ Поле: Тема письма (text input)
    ├─ WYSIWYG редактор: Текст письма (с переменными {{donor_name}}, {{amount}} и т.д.)
    ├─ Preview: Предпросмотр письма
    └─ Справка: Доступные переменные для этого шаблона

    ↓
[Администратор редактирует текст]
    ├─ Может менять тему письма
    ├─ Может менять HTML/text тело письма
    └─ Видит предпросмотр в реальном времени

    ↓
[Сохранить изменения]
    ├─ API REQUEST to Integration Service Backend:
    │  "UPDATE email_templates SET subject = ..., body_html = ... WHERE id = ..."
    │
    └─ Опционально:
       API REQUEST to Unisender Go:
       "PUT /api/v1.0/templates/{template_id}" (если использует шаблоны Unisender)

    ↓
[Отобразить статус: "✓ Шаблон сохранён"]
    ├─ Версия шаблона
    └─ Дата последнего изменения: 2025-11-02 22:15

    ↓
DECISION: "Отредактировать другой шаблон?"
    ├─ YES → Вернуться к списку шаблонов
    └─ NO → END
```

---

#### Процесс 4: Ручная переотправка писем (ФТ-019)

```
START: Администратор входит в раздел "Неудачные письма"

    ↓
[Загрузить список неудачных писем]
    ├─ Фильтр: Дата (по умолчанию последние 7 дней)
    ├─ Фильтр: Тип письма
    ├─ Фильтр: Email адрес донора/пользователя
    ├─ Фильтр: Причина ошибки (429, 5xx, SMTP ошибка и т.д.)
    └─ Кнопка "Применить фильтры"

    ↓
[Отобразить таблицу]
    ├─ Колонки: Checkbox, Email, Тип письма, Причина ошибки, Дата попытки
    └─ Сортировка по дате (новые сверху)

    ↓
[Администратор выбирает письма через чекбоксы]
    ├─ Может выбрать одно письмо
    ├─ Может выбрать несколько
    └─ Может нажать "Выбрать все"

    ↓
[Нажать кнопку "Переотправить выбранные"]
    ├─ Всплывающее окно: "Вы уверены? Переотправить N писем?"
    └─ Кнопки: "Да, переотправить" / "Отмена"

    ↓
API REQUEST to Integration Service Backend:
INSERT INTO retry_queue (trigger_id, retry_count, next_attempt_at, manual_resend)
VALUES (?, 0, NOW(), true)

    ↓
Integration Service обрабатывает retry_queue:
[Service Task: Получить письмо из очереди]
    ↓
[Подпроцесс: Отправить письмо через Unisender]
    ├─ Успех → [Логирование: sent, manually_resent = true]
    └─ Ошибка → [Добавить обратно в retry_queue]

    ↓
[Получить результаты переотправки]
    ├─ Таблица с результатами:
    │  Email | Результат | Статус сообщения ID
    ├─ Зелёная галочка ✓ для успехов
    ├─ Красный крест ✗ для ошибок
    └─ Информационное сообщение: "Переотправлено 5 из 6 писем"

    ↓
[Скачать отчёт переотправки]
    └─ CSV с результатами

    ↓
DECISION: "Переотправить другие письма?"
    ├─ YES → Вернуться к списку
    └─ NO → END
```

---

#### Процесс 5: Мониторинг здоровья системы (НФТ-5.2)

```
START: Периодическая проверка (каждые 5 минут) или ручной запрос администратора

    ↓
[Загрузить раздел "Мониторинг"]
    ├─ Дашборд с индикаторами здоровья
    └─ Автообновление каждые 30 сек

    ↓
[Проверить доступность Unisender Go]
    ├─ API GET /health (или POST с пингом)
    ├─ Ожидается: Response 200 < 2 сек
    └─ Если ошибка → красный индикатор, alert

    ↓
[Проверить доступность CloudPayments]
    ├─ API GET /health
    └─ Если ошибка → красный индикатор

    ↓
[Проверить доступность MixPlat]
    ├─ API GET /health
    └─ Если ошибка → красный индикатор

    ↓
[Проверить доступность БД Битрикс]
    ├─ SELECT 1 FROM events LIMIT 1
    └─ Если ошибка → красный индикатор

    ↓
[Проверить очередь триггеров]
    ├─ SELECT COUNT(*) FROM integration_triggers WHERE status = 'pending'
    ├─ Если > 1000 → жёлтый индикатор (перегруз)
    └─ Если > 5000 → красный индикатор (критично)

    ↓
[Проверить очередь retry]
    ├─ SELECT COUNT(*) FROM retry_queue WHERE status = 'pending'
    └─ Если > 100 → жёлтый индикатор

    ↓
[Отобразить дашборд мониторинга]
    ├─ Карточка: Unisender Go - ● GREEN/YELLOW/RED
    ├─ Карточка: CloudPayments - ● GREEN/YELLOW/RED
    ├─ Карточка: MixPlat - ● GREEN/YELLOW/RED
    ├─ Карточка: Битрикс БД - ● GREEN/YELLOW/RED
    ├─ Карточка: Очередь триггеров - N (текущее количество)
    ├─ Карточка: Очередь retry - M (текущее количество)
    ├─ Карточка: Средний response time Unisender - 450ms
    ├─ Карточка: Последний успешный запрос - 2 сек назад
    └─ Кнопка: "Отправить alert на email администраторам"

    ↓
DECISION: "Нужна ручная переотправка?"
    ├─ YES → Перейти в раздел "Неудачные письма"
    └─ NO → END

    ↓
IF статус = RED:
    Отправить Telegram alert администратору
    Отправить email alert
```

---

#### Процесс 6: Просмотр логов (НФТ-5.1)

```
START: Администратор входит в раздел "Логи"

    ↓
[Загрузить форму поиска]
    ├─ Фильтр: Дата (от - до)
    ├─ Фильтр: Уровень логирования (INFO, WARNING, ERROR)
    ├─ Фильтр: Компонент (Unisender, Bitrix, Payment System)
    ├─ Фильтр: Email или Event ID
    └─ Поле поиска по тексту

    ↓
[Администратор вводит фильтры]
    ↓
[Нажать "Поиск"]

    ↓
API REQUEST to Integration Service Backend:
SELECT * FROM processing_logs WHERE ... ORDER BY created_at DESC LIMIT 1000

    ↓
[Отобразить таблицу логов]
    ├─ Колонки: Timestamp, Level, Component, Message, Details
    └─ Может развернуть каждую строку для полной информации

    ↓
DECISION: "Экспортировать логи?"
    ├─ YES → [Скачать CSV / JSON]
    └─ NO → END
```

---

### 📐 Общая структура диаграммы администратора в BPMN

```
┌─────────────────────────────────────────────────────────────────────┐
│                      АДМИНИСТРАТОР                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ Lane 1.1: Модерация событий                                 │    │
│  │  [Вход в админку] → [Список событий] → [Выбрать событие]   │    │
│  │      ↓                                                       │    │
│  │  [Просмотреть детали] → Gateway "Одобрить?" → [Одобрение]  │    │
│  │                             ↓                    [Отклонение]│    │
│  │                         SEND to Bitrix (MESSAGE FLOW)        │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ Lane 1.2: Просмотр статистики                              │    │
│  │  [Раздел "Статистика"] → [Выбрать фильтры]                │    │
│  │      ↓                                                       │    │
│  │  [API запрос] → RECEIVE from Integration Service            │    │
│  │      ↓                                                       │    │
│  │  [Отобразить дашборд с метриками OR/DR/CTR/CTOR]          │    │
│  │      ↓                                                       │    │
│  │  [Экспорт отчёта]                                          │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ Lane 1.3: Управление коммуникациями                        │    │
│  │  [Раздел "Шаблоны"] → [Выбрать шаблон]                    │    │
│  │      ↓                                                       │    │
│  │  [WYSIWYG редактор] → [Сохранить]                         │    │
│  │      ↓                                                       │    │
│  │  SEND to Integration Service: UPDATE templates              │    │
│  │      ↓                                                       │    │
│  │  [Отобразить статус "✓ Сохранено"]                        │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ Lane 1.4: Ручные операции                                  │    │
│  │  [Раздел "Неудачные письма"] → [Фильтры]                   │    │
│  │      ↓                                                       │    │
│  │  [Выбрать письма] → [Кнопка "Переотправить"]              │    │
│  │      ↓                                                       │    │
│  │  SEND to Integration Service: INSERT into retry_queue       │    │
│  │      ↓                                                       │    │
│  │  [Получить результаты] → [Отобразить таблицу результатов] │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ Lane 1.5: Мониторинг системы                               │    │
│  │  [Раздел "Мониторинг"] → [Timer Event каждые 5 мин]       │    │
│  │      ↓                                                       │    │
│  │  [Проверить доступность сервисов]                         │    │
│  │      ↓                                                       │    │
│  │  [Отобразить дашборд: GREEN/YELLOW/RED индикаторы]        │    │
│  │      ↓                                                       │    │
│  │  [При RED отправить alert]                                 │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                   АДМИН-ПАНЕЛЬ (UI / Backend API)                   │
├─────────────────────────────────────────────────────────────────────┤
│  ← (Sequence Flow для UI/API взаимодействия)                        │
│                                                                       │
│  Lane 2.1: Backend API                                              │
│   [Аутентификация] [Загрузка данных] [Обновление] [Логирование]    │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                    ПЛАТФОРМА (Битрикс) / БД                         │
├─────────────────────────────────────────────────────────────────────┤
│  ← (Message Flow для синхронизации данных)                          │
│                                                                       │
│  Lane 3.1: База данных (SELECT, UPDATE, INSERT)                    │
│  Lane 3.2: Уведомления (Генерация триггеров)                       │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│              ИНТЕГРАЦИОННЫЙ СЕРВИС (Python/FastAPI)                 │
├─────────────────────────────────────────────────────────────────────┤
│  ← (Message Flow для обработки trigg и отправки)                    │
│                                                                       │
│  Lane 4.1: Обработка (Business Rules, API запросы, retry логика)   │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                        UNISENDER GO (Email)                          │
├─────────────────────────────────────────────────────────────────────┤
│  ← (Message Flow для отправки / получения statistic)                │
│                                                                       │
│  Lane 5.1: Email отправка (API /send, /subscribe, /event-dump)     │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│              ПЛАТЕЖНЫЕ СИСТЕМЫ (CloudPayments / MixPlat)             │
├─────────────────────────────────────────────────────────────────────┤
│  ← (Message Flow для проверки статуса, мониторинга)                 │
│                                                                       │
│  Lane 6.1: API запросы (GET /health, мониторинг)                   │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 📋 Ключевые точки интеграции администратора с другими системами

| # | Action | От (Admin) | К (System) | Message Flow | Тип |
|---|--------|-----------|-----------|-------------|------|
| 1 | Одобрить событие | Lane 1.1 | Платформа Lane 3.1 | UPDATE events SET status='published' | Sync |
| 2 | Отклонить событие | Lane 1.1 | Платформа Lane 3.1 | UPDATE events SET status='rejected' | Sync |
| 3 | Загрузить статистику | Lane 1.2 | Int. Service Lane 4.1 | SELECT * FROM processing_logs | Query |
| 4 | Загрузить статистику | Lane 1.2 | Unisender | GET /event-dump | API |
| 5 | Сохранить шаблон | Lane 1.3 | Int. Service Lane 4.1 | UPDATE email_templates | Sync |
| 6 | Переотправить письма | Lane 1.4 | Int. Service Lane 4.1 | INSERT INTO retry_queue | Sync |
| 7 | Получить результаты | Lane 1.4 | Int. Service Lane 4.1 | SELECT FROM processing_logs (manual_resent=true) | Query |
| 8 | Проверить здоровье | Lane 1.5 | Unisender Lane 5.1 | GET /health | Health Check |
| 9 | Проверить здоровье | Lane 1.5 | CloudPayments Lane 6.1 | GET /health | Health Check |
| 10 | Проверить здоровье | Lane 1.5 | MixPlat Lane 6.1 | GET /health | Health Check |
| 11 | Проверить триггеры | Lane 1.5 | Платформа Lane 3.1 | SELECT COUNT(*) FROM integration_triggers | Query |
| 12 | Проверить retry queue | Lane 1.5 | Int. Service Lane 4.1 | SELECT COUNT(*) FROM retry_queue | Query |

---

## Часть 4: Итоговая спецификация в Markdown

Все рекомендации и решения оформлены выше. Вот краткая сводка:

### ✅ Завершено

1. **Анализ ошибок BPMN нотации** - выявлены 24 ошибки в трёх диаграммах
   - Незавершённые потоки (dangling flows)
   - Отсутствующие End Events
   - Неправильные типы задач
   - Отсутствующие Gateway объединения
   - Недостающие Timer Events

2. **Подпроцессы для модульности** - определены 5 подпроцессов
   - Валидация и подготовка данных
   - Отправка письма через Unisender
   - Обработка результата платежа
   - Выбор шаблона письма
   - Регистрация на платформе (уже существует)

3. **Диаграмма администратора** - новая диаграмма с 5 lanes
   - Модерация событий
   - Просмотр статистики
   - Управление шаблонами
   - Ручные операции
   - Мониторинг системы

4. **Правила соединения подпроцессов**
   - Использование Call Activity
   - Input/Output Mapping
   - Boundary Events для ошибок
   - XOR Join для объединения путей

### 🎯 Следующие шаги

1. Создать исправленные BPMN диаграммы с учётом ошибок
2. Реализовать подпроцессы как отдельные BPMN файлы
3. Создать диаграмму администратора в Camunda Modeler
4. Согласовать с заказчиком все изменения
5. Начать разработку интеграционного сервиса
