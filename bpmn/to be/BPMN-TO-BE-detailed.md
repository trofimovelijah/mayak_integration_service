# BPMN TO-BE: Детальная спецификация автоматизированных процессов

## Общая информация

**Название процесса**: Автоматизированная система коммуникаций платформы  
**Версия**: 2.0  
**Дата**: 25.10.2025  
**Статус**: TO-BE (Целевое состояние)

---

## Пулы (Pools) и дорожки (Lanes)

### Pool 1: Пользователь платформы
- **Lane 1.1**: Регистрация и создание событий
- **Lane 1.2**: Мониторинг результатов

### Pool 2: Благотворитель (Донор)
- **Lane 2.1**: Выбор события
- **Lane 2.2**: Оформление пожертвования
- **Lane 2.3**: Управление подписками

### Pool 3: Администратор
- **Lane 3.1**: Модерация событий
- **Lane 3.2**: Работа с админ-панелью
- **Lane 3.3**: Просмотр статистики

### Pool 4: Платформа (Битрикс)
- **Lane 4.1**: Хранение данных
- **Lane 4.2**: Генерация триггеров

### Pool 5: Интеграционный сервис (Python)
- **Lane 5.1**: Обработка триггеров
- **Lane 5.2**: Валидация и бизнес-правила
- **Lane 5.3**: Взаимодействие с внешними API
- **Lane 5.4**: Retry механизм
- **Lane 5.5**: Логирование

### Pool 6: БД интеграционного сервиса
- **Lane 6.1**: Очередь триггеров
- **Lane 6.2**: Очередь писем
- **Lane 6.3**: Логи и статистика

### Pool 7: Админ-панель (UI)
- **Lane 7.1**: Дашборд
- **Lane 7.2**: Управление шаблонами
- **Lane 7.3**: Управление сценариями

### Pool 8: Unisender Go
- **Lane 8.1**: Отправка писем
- **Lane 8.2**: Статистика

### Pool 9: Платежные системы (CloudPayment/MixPlat)
- **Lane 9.1**: Обработка разовых платежей
- **Lane 9.2**: Рекуррентные списания

---

## Процесс 1: Создание и публикация события (TO-BE)

### Элементы диаграммы

#### Start Event
- **ID**: SE_100
- **Название**: "Пользователь решает создать событие"
- **Тип**: None Start Event
- **Pool**: Пользователь платформы
- **Lane**: 1.1

#### Task 1: Регистрация
- **ID**: UT_100
- **Название**: "Регистрация на платформе"
- **Тип**: User Task
- **Pool**: Пользователь платформы
- **Lane**: 1.1
- **Входящие потоки**: SE_100
- **Исходящие потоки**: UT_101

#### Task 2: Создание события
- **ID**: UT_101
- **Название**: "Создание события"
- **Тип**: User Task
- **Pool**: Пользователь платформы
- **Lane**: 1.1
- **Входящие потоки**: UT_100
- **Исходящие потоки**: ST_100
- **Форма**: event_creation_form

#### Task 3: Отправка на модерацию
- **ID**: ST_100
- **Название**: "Отправка события на модерацию"
- **Тип**: Send Task
- **Pool**: Пользователь платформы
- **Lane**: 1.1
- **Входящие потоки**: UT_101
- **Исходящие потоки**: MSG_100

#### Message Flow 1
- **ID**: MSG_100
- **От**: ST_100 (Pool: Пользователь)
- **К**: ST_101 (Pool: Платформа Битрикс)

#### Task 4: Сохранение события в БД
- **ID**: ST_101
- **Название**: "Сохранение события в БД"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платформа (Битрикс)
- **Lane**: 4.1 Хранение данных
- **Входящие потоки**: MSG_100
- **Исходящие потоки**: ST_102
- **SQL**: `INSERT INTO events (user_id, title, description, target_amount, status, created_at) VALUES (?, ?, ?, ?, 'moderation_pending', NOW())`

#### Task 5: Генерация триггера
- **ID**: ST_102
- **Название**: "Запись триггера в таблицу"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платформа (Битрикс)
- **Lane**: 4.2 Генерация триггеров
- **Входящие потоки**: ST_101
- **Исходящие потоки**: TE_100
- **SQL**: `INSERT INTO integration_triggers (trigger_type, entity_id, status, payload, created_at) VALUES ('event_created', ?, 'pending', ?, NOW())`
- **Payload**: JSON с полными данными события

#### Timer Event 1: Polling триггеров
- **ID**: TE_100
- **Название**: "Периодическая проверка новых триггеров"
- **Тип**: Timer Intermediate Event (Cycle)
- **Pool**: Интеграционный сервис
- **Lane**: 5.1 Обработка триггеров
- **Периодичность**: Каждые 10 секунд
- **Выражение**: `R/PT10S` (ISO 8601)
- **Исходящие потоки**: ST_110

#### Task 6: Polling БД Битрикс
- **ID**: ST_110
- **Название**: "Чтение новых триггеров из БД Битрикс"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.1
- **Входящие потоки**: TE_100
- **Исходящие потоки**: GW_100
- **SQL**: `SELECT * FROM integration_triggers WHERE status = 'pending' AND trigger_type = 'event_created' ORDER BY created_at LIMIT 100`

#### Gateway 1: Есть новые триггеры?
- **ID**: GW_100
- **Название**: "Найдены новые триггеры?"
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Интеграционный сервис
- **Lane**: 5.1
- **Входящие потоки**: ST_110
- **Исходящие потоки**: ST_111 (да), TE_100 (нет, ждать следующего цикла)
- **Условие (да)**: `trigger_count > 0`
- **Условие (нет)**: `trigger_count == 0`

#### Task 7: Валидация данных события
- **ID**: ST_111
- **Название**: "Валидация данных триггера"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.2 Валидация и бизнес-правила
- **Входящие потоки**: GW_100 (да)
- **Исходящие потоки**: GW_101
- **Проверки**:
  - Наличие обязательных полей (event_id, title, user_email)
  - Валидность email администратора
  - Корректность JSON payload

#### Gateway 2: Данные валидны?
- **ID**: GW_101
- **Название**: "Валидация успешна?"
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Интеграционный сервис
- **Lane**: 5.2
- **Входящие потоки**: ST_111
- **Исходящие потоки**: ST_112 (да), ST_113 (нет)

#### Task 8a: Формирование уведомления администратору
- **ID**: ST_112
- **Название**: "Подготовка email администратору"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.2
- **Входящие потоки**: GW_101 (да)
- **Исходящие потоки**: ST_114
- **Действия**:
  - Получение email администратора из конфигурации
  - Загрузка шаблона письма "new_event_for_moderation"
  - Подстановка переменных (event_title, event_description, moderation_link)

#### Task 8b: Логирование ошибки валидации
- **ID**: ST_113
- **Название**: "Логирование ошибки"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.5 Логирование
- **Входящие потоки**: GW_101 (нет)
- **Исходящие потоки**: ST_115
- **SQL**: `INSERT INTO processing_logs (trigger_id, status, error_message, created_at) VALUES (?, 'validation_failed', ?, NOW())`

#### Task 9: API запрос в Unisender Go
- **ID**: ST_114
- **Название**: "Отправка email через Unisender Go"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.3 Взаимодействие с внешними API
- **Входящие потоки**: ST_112
- **Исходящие потоки**: GW_102
- **API**: `POST https://go1.unisender.ru/ru/transactional/api/v1/email/send`
- **Headers**: 
  - `Authorization: Bearer {api_key}`
  - `Content-Type: application/json`
- **Body**:
```json
{
  "message": {
    "recipients": [{"email": "admin@mayak.help"}],
    "template_id": "new_event_moderation",
    "global_substitutions": {
      "event_title": "...",
      "event_description": "...",
      "moderation_link": "https://join.mayak.help/admin/events/..."
    }
  }
}
```

#### Gateway 3: Результат API запроса
- **ID**: GW_102
- **Название**: "API запрос успешен?"
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Интеграционный сервис
- **Lane**: 5.3
- **Входящие потоки**: ST_114
- **Исходящие потоки**: ST_116 (200 OK), ST_117 (429/5xx), ST_118 (4xx)
- **Условия**:
  - `api_response_code == 200` → успех
  - `api_response_code == 429 || api_response_code >= 500` → retry
  - `400 <= api_response_code < 500 && api_response_code != 429` → ошибка клиента

#### Task 10a: Логирование успеха
- **ID**: ST_116
- **Название**: "Логирование успешной отправки"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.5 Логирование
- **Входящие потоки**: GW_102 (200 OK)
- **Исходящие потоки**: ST_119
- **SQL**: `INSERT INTO processing_logs (trigger_id, status, message_id, created_at) VALUES (?, 'sent', ?, NOW())`
- **SQL**: `UPDATE integration_triggers SET status = 'processed' WHERE id = ?`

#### Task 10b: Добавление в очередь retry
- **ID**: ST_117
- **Название**: "Добавление в retry_queue"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.4 Retry механизм
- **Входящие потоки**: GW_102 (429/5xx)
- **Исходящие потоки**: GW_103
- **SQL**: `INSERT INTO retry_queue (trigger_id, retry_count, next_attempt_at, last_error) VALUES (?, 1, NOW() + INTERVAL '1 second', ?)`

#### Task 10c: Логирование финальной ошибки
- **ID**: ST_118
- **Название**: "Логирование ошибки клиента"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.5
- **Входящие потоки**: GW_102 (4xx)
- **Исходящие потоки**: ST_119
- **SQL**: `INSERT INTO processing_logs (trigger_id, status, error_code, error_message) VALUES (?, 'failed', ?, ?)`
- **SQL**: `UPDATE integration_triggers SET status = 'failed' WHERE id = ?`

#### Gateway 4: Нужен retry?
- **ID**: GW_103
- **Название**: "Retry count < 3?"
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Интеграционный сервис
- **Lane**: 5.4
- **Входящие потоки**: ST_117
- **Исходящие потоки**: TE_101 (да), ST_118 (нет)
- **Условие (да)**: `retry_count < 3`
- **Условие (нет)**: `retry_count >= 3`

#### Timer Event 2: Задержка перед retry
- **ID**: TE_101
- **Название**: "Ожидание перед повтором"
- **Тип**: Timer Intermediate Event
- **Pool**: Интеграционный сервис
- **Lane**: 5.4
- **Входящие потоки**: GW_103 (да)
- **Исходящие потоки**: ST_114 (повтор API запроса)
- **Длительность**: `PT{2^retry_count}S` (1с, 2с, 4с, 8с)

#### Task 11: Обновление статуса триггера
- **ID**: ST_119
- **Название**: "Финализация обработки триггера"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.1
- **Входящие потоки**: ST_116, ST_118
- **Исходящие потоки**: TE_100 (возврат к polling)
- **SQL**: `UPDATE integration_triggers SET processed_at = NOW() WHERE id = ?`

#### Message Flow 2: Email администратору
- **ID**: MSG_101
- **От**: Unisender Go (фактически)
- **К**: RT_100 (Pool: Администратор)

#### Task 12: Получение email
- **ID**: RT_100
- **Название**: "Получение уведомления о новом событии"
- **Тип**: Receive Task
- **Pool**: Администратор
- **Lane**: 3.1 Модерация событий
- **Входящие потоки**: MSG_101
- **Исходящие потоки**: UT_110

#### Task 13: Переход в админ-панель Битрикс
- **ID**: UT_110
- **Название**: "Просмотр события в админке"
- **Тип**: User Task
- **Pool**: Администратор
- **Lane**: 3.1
- **Входящие потоки**: RT_100
- **Исходящие потоки**: UT_111
- **Действие**: Переход по ссылке из письма

#### Task 14: Модерация события
- **ID**: UT_111
- **Название**: "Проверка и принятие решения"
- **Тип**: User Task
- **Pool**: Администратор
- **Lane**: 3.1
- **Входящие потоки**: UT_110
- **Исходящие потоки**: GW_110

#### Gateway 5: Решение модерации
- **ID**: GW_110
- **Название**: "Событие одобрено?"
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Администратор
- **Lane**: 3.1
- **Входящие потоки**: UT_111
- **Исходящие потоки**: ST_120 (да), ST_121 (нет)

#### Task 15a: Одобрение события
- **ID**: ST_120
- **Название**: "Изменение статуса на 'published'"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платформа (Битрикс)
- **Lane**: 4.1
- **Входящие потоки**: GW_110 (да)
- **Исходящие потоки**: GW_111
- **SQL**: `UPDATE events SET status = 'published', published_at = NOW() WHERE id = ?`

#### Task 15b: Отклонение события
- **ID**: ST_121
- **Название**: "Изменение статуса на 'rejected'"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платформа (Битрикс)
- **Lane**: 4.1
- **Входящие потоки**: GW_110 (нет)
- **Исходящие потоки**: GW_111
- **SQL**: `UPDATE events SET status = 'rejected', rejection_reason = ?, rejected_at = NOW() WHERE id = ?`

#### Gateway 6: Merge
- **ID**: GW_111
- **Название**: "Объединение потоков"
- **Тип**: Exclusive Gateway (XOR - Join)
- **Pool**: Платформа (Битрикс)
- **Lane**: 4.1
- **Входящие потоки**: ST_120, ST_121
- **Исходящие потоки**: ST_122

#### Task 16: Генерация триггера об изменении статуса
- **ID**: ST_122
- **Название**: "Запись триггера 'event_status_changed'"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платформа (Битрикс)
- **Lane**: 4.2
- **Входящие потоки**: GW_111
- **Исходящие потоки**: TE_100 (обработка через polling)
- **SQL**: `INSERT INTO integration_triggers (trigger_type, entity_id, status, payload) VALUES ('event_status_changed', ?, 'pending', ?)`

#### Task 17: Обработка триггера изменения статуса
- **ID**: ST_130
- **Название**: "Обработка триггера"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.1
- **Входящие потоки**: (из polling TE_100)
- **Исходящие потоки**: ST_131

#### Task 18: Определение типа письма
- **ID**: ST_131
- **Название**: "Выбор шаблона (одобрение/отказ)"
- **Тип**: Business Rule Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.2
- **Входящие потоки**: ST_130
- **Исходящие потоки**: ST_132
- **Логика**:
  - IF status == 'published' THEN template = 'event_approved'
  - ELSE IF status == 'rejected' THEN template = 'event_rejected'

#### Task 19: API запрос в Unisender Go (пользователю)
- **ID**: ST_132
- **Название**: "Отправка результата модерации"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.3
- **Входящие потоки**: ST_131
- **Исходящие потоки**: GW_120
- **Аналогично**: ST_114 (с той же retry логикой)

#### Gateway 7: Результат API
- **ID**: GW_120
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Интеграционный сервис
- **Lane**: 5.3
- **Входящие потоки**: ST_132
- **Исходящие потоки**: ST_133 (успех), retry механизм
- **Аналогично**: GW_102

#### Task 20: Логирование результата
- **ID**: ST_133
- **Название**: "Логирование отправки пользователю"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.5
- **Входящие потоки**: GW_120 (успех)
- **Исходящие потоки**: EE_100

#### Message Flow 3: Email пользователю
- **ID**: MSG_102
- **От**: Unisender Go
- **К**: RT_101 (Pool: Пользователь)

#### Task 21: Получение результата модерации
- **ID**: RT_101
- **Название**: "Получение email о публикации/отклонении"
- **Тип**: Receive Task
- **Pool**: Пользователь платформы
- **Lane**: 1.2 Мониторинг результатов
- **Входящие потоки**: MSG_102
- **Исходящие потоки**: EE_101

#### End Event 1 (Интеграционный сервис)
- **ID**: EE_100
- **Название**: "Триггер обработан"
- **Тип**: None End Event
- **Pool**: Интеграционный сервис
- **Lane**: 5.5

#### End Event 2 (Пользователь)
- **ID**: EE_101
- **Название**: "Процесс завершен"
- **Тип**: None End Event
- **Pool**: Пользователь платформы
- **Lane**: 1.2

---

## Процесс 2: Пожертвование и благодарность (TO-BE)

### Элементы диаграммы

#### Start Event
- **ID**: SE_200
- **Название**: "Благотворитель выбирает событие"
- **Тип**: None Start Event
- **Pool**: Благотворитель
- **Lane**: 2.1

#### Task 1-4: Аналогично AS-IS
- **ID**: UT_200 - UT_203
- **Описание**: Просмотр событий, выбор, заполнение формы, подтверждение

#### Message Flow: К платежной системе
- **ID**: MSG_200
- **От**: UT_203 (Pool: Благотворитель)
- **К**: ST_210 (Pool: Платежные системы)

#### Task 5: Обработка платежа
- **ID**: ST_210
- **Название**: "Обработка платежа"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платежные системы
- **Lane**: 9.1
- **Входящие потоки**: MSG_200
- **Исходящие потоки**: GW_200

#### Gateway: Результат платежа
- **ID**: GW_200
- **Название**: "Платеж успешен?"
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Платежные системы
- **Lane**: 9.1
- **Входящие потоки**: ST_210
- **Исходящие потоки**: ST_211 (успех), ST_212 (ошибка)

#### Task 6a: Callback успеха
- **ID**: ST_211
- **Название**: "Отправка callback success"
- **Тип**: Send Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платежные системы
- **Lane**: 9.1
- **Входящие потоки**: GW_200 (успех)
- **Исходящие потоки**: MSG_201
- **Payload**:
```json
{
  "status": "success",
  "transaction_id": "...",
  "amount": 1000.00,
  "donor_email": "...",
  "donor_name": "...",
  "event_id": "..."
}
```

#### Task 6b: Callback ошибки
- **ID**: ST_212
- **Название**: "Отправка callback fail"
- **Тип**: Send Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платежные системы
- **Lane**: 9.1
- **Входящие потоки**: GW_200 (ошибка)
- **Исходящие потоки**: MSG_202

#### Message Flow (успех)
- **ID**: MSG_201
- **От**: ST_211 (Pool: Платежные системы)
- **К**: RT_210 (Pool: Платформа Битрикс)

#### Message Flow (ошибка)
- **ID**: MSG_202
- **От**: ST_212
- **К**: RT_210

#### Task 7: Получение callback
- **ID**: RT_210
- **Название**: "Получение callback от платежной системы"
- **Тип**: Receive Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платформа (Битрикс)
- **Lane**: 4.2
- **Входящие потоки**: MSG_201, MSG_202
- **Исходящие потоки**: ST_220

#### Task 8: Сохранение пожертвования
- **ID**: ST_220
- **Название**: "Сохранение в БД"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платформа (Битрикс)
- **Lane**: 4.1
- **Входящие потоки**: RT_210
- **Исходящие потоки**: GW_201
- **SQL**: `INSERT INTO donations (event_id, donor_email, donor_name, amount, status, transaction_id) VALUES (?, ?, ?, ?, ?, ?)`

#### Gateway: Платеж успешен?
- **ID**: GW_201
- **Название**: "Status == 'success'?"
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Платформа (Битрикс)
- **Lane**: 4.1
- **Входящие потоки**: ST_220
- **Исходящие потоки**: ST_221 (да), EE_200 (нет, завершение)

#### Task 9: Генерация триггера
- **ID**: ST_221
- **Название**: "Запись триггера 'donation_received'"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Платформа (Битрикс)
- **Lane**: 4.2
- **Входящие потоки**: GW_201 (да)
- **Исходящие потоки**: (polling)
- **SQL**: `INSERT INTO integration_triggers (trigger_type, entity_id, status, payload) VALUES ('donation_received', ?, 'pending', ?)`

#### Task 10: Обработка триггера интеграционным сервисом
- **ID**: ST_230
- **Название**: "Получение триггера через polling"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.1
- **Входящие потоки**: (polling TE_100)
- **Исходящие потоки**: ST_231

#### Task 11: Валидация email
- **ID**: ST_231
- **Название**: "Валидация email донора (RFC 5322)"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.2
- **Входящие потоки**: ST_230
- **Исходящие потоки**: GW_210
- **Проверки**:
  - Формат email (regex)
  - Наличие @ и валидного домена
  - Длина < 320 символов
  - Не в blacklist

#### Gateway: Email валиден?
- **ID**: GW_210
- **Название**: "Email прошел валидацию?"
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Интеграционный сервис
- **Lane**: 5.2
- **Входящие потоки**: ST_231
- **Исходящие потоки**: ST_232 (да), ST_240 (нет, логирование ошибки)

#### Task 12: Проверка дедупликации
- **ID**: ST_232
- **Название**: "Проверка на дубликаты"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.2
- **Входящие потоки**: GW_210 (да)
- **Исходящие потоки**: GW_211
- **SQL**: `SELECT COUNT(*) FROM processing_logs WHERE recipient_email = ? AND trigger_type = 'donation_received' AND status = 'sent' AND created_at > NOW() - INTERVAL '24 hours'`

#### Gateway: Найден дубликат?
- **ID**: GW_211
- **Название**: "Дубликат в последние 24 часа?"
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Интеграционный сервис
- **Lane**: 5.2
- **Входящие потоки**: ST_232
- **Исходящие потоки**: ST_233 (нет дубликата), ST_241 (да, логирование skip)
- **Условие**: `duplicate_count == 0`

#### Task 13: Определение типа шаблона
- **ID**: ST_233
- **Название**: "Выбор шаблона по сумме"
- **Тип**: Business Rule Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.2
- **Входящие потоки**: GW_211 (нет дубликата)
- **Исходящие потоки**: ST_234
- **Бизнес-правила**:
```python
if amount < 1000:
    template_id = "donation_thanks_basic"
elif amount < 50000:
    template_id = "donation_thanks_extended"
else:
    template_id = "donation_thanks_vip"
```

#### Task 14: Проверка первого пожертвования
- **ID**: ST_234
- **Название**: "Проверка истории донора"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.2
- **Входящие потоки**: ST_233
- **Исходящие потоки**: GW_212
- **SQL**: `SELECT COUNT(*) FROM donations WHERE donor_email = ?`
- **SQL** (интеграционный сервис): `SELECT COUNT(*) FROM processing_logs WHERE recipient_email = ? AND trigger_type = 'donation_received'`

#### Gateway: Первое пожертвование?
- **ID**: GW_212
- **Название**: "Это первое пожертвование донора?"
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Интеграционный сервис
- **Lane**: 5.2
- **Входящие потоки**: ST_234
- **Исходящие потоки**: ST_235 (да), ST_236 (нет)
- **Условие**: `donation_count == 1`

#### Task 15a: Добавление приветственного блока
- **ID**: ST_235
- **Название**: "Формирование с приветствием"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.2
- **Входящие потоки**: GW_212 (да)
- **Исходящие потоки**: GW_213
- **Действие**: Добавление секции "welcome_block" в substitutions

#### Task 15b: Стандартная благодарность
- **ID**: ST_236
- **Название**: "Формирование стандартного письма"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.2
- **Входящие потоки**: GW_212 (нет)
- **Исходящие потоки**: GW_213

#### Gateway: Merge
- **ID**: GW_213
- **Тип**: Exclusive Gateway (XOR - Join)
- **Pool**: Интеграционный сервис
- **Lane**: 5.2
- **Входящие потоки**: ST_235, ST_236
- **Исходящие потоки**: ST_237

#### Task 16: Формирование JSON для API
- **ID**: ST_237
- **Название**: "Подготовка данных для Unisender Go"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.3
- **Входящие потоки**: GW_213
- **Исходящие потоки**: ST_238
- **Payload**:
```json
{
  "message": {
    "recipients": [{"email": "donor@example.com"}],
    "template_id": "donation_thanks_extended",
    "global_substitutions": {
      "donor_name": "Иван Иванов",
      "amount": "5000.00",
      "transaction_id": "TXN123456",
      "date": "25.10.2025",
      "welcome_block": "..." (если первое)
    },
    "track_read": 1,
    "track_links": 1
  }
}
```

#### Task 17: API запрос в Unisender Go
- **ID**: ST_238
- **Название**: "POST /email/send"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.3
- **Входящие потоки**: ST_237
- **Исходящие потоки**: GW_220

#### Gateway: Результат API
- **ID**: GW_220
- **Название**: "API response code?"
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Интеграционный сервис
- **Lane**: 5.3
- **Входящие потоки**: ST_238
- **Исходящие потоки**: ST_250 (200 OK), ST_251 (429/5xx), ST_252 (4xx)

#### Task 18a: Логирование успеха
- **ID**: ST_250
- **Название**: "Логирование: sent"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.5
- **Входящие потоки**: GW_220 (200)
- **Исходящие потоки**: EE_210
- **SQL**: `INSERT INTO processing_logs (trigger_id, recipient_email, status, message_id, created_at) VALUES (?, ?, 'sent', ?, NOW())`

#### Task 18b: Добавление в retry_queue
- **ID**: ST_251
- **Название**: "Добавление в очередь повторов"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.4 Retry механизм
- **Входящие потоки**: GW_220 (429/5xx)
- **Исходящие потоки**: GW_221

#### Gateway: Retry count < 3?
- **ID**: GW_221
- **Название**: "Осталось попыток?"
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Интеграционный сервис
- **Lane**: 5.4
- **Входящие потоки**: ST_251
- **Исходящие потоки**: TE_200 (да), ST_252 (нет)
- **Условие**: `retry_count < 3`

#### Timer Event: Экспоненциальная задержка
- **ID**: TE_200
- **Название**: "Задержка перед retry"
- **Тип**: Timer Intermediate Event
- **Pool**: Интеграционный сервис
- **Lane**: 5.4
- **Входящие потоки**: GW_221 (да)
- **Исходящие потоки**: ST_238 (повтор API запроса)
- **Формула**: `PT{2^retry_count}S`
- **Примеры**: 
  - retry_count=1: PT1S (1 секунда)
  - retry_count=2: PT2S (2 секунды)
  - retry_count=3: PT4S (4 секунды)

#### Task 18c: Логирование финальной ошибки
- **ID**: ST_252
- **Название**: "Логирование: failed"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.5
- **Входящие потоки**: GW_220 (4xx) или GW_221 (исчерпаны retry)
- **Исходящие потоки**: EE_211
- **SQL**: `INSERT INTO processing_logs (trigger_id, status, error_code, error_message, retry_count) VALUES (?, 'failed', ?, ?, ?)`

#### Task 19: Отправка email благотворителю
- **ID**: ST_260
- **Название**: "Доставка email Unisender Go"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Unisender Go
- **Lane**: 8.1 Отправка писем
- **Входящие потоки**: (внутренняя логика после ST_238 успех)
- **Исходящие потоки**: MSG_210

#### Message Flow: Email благотворителю
- **ID**: MSG_210
- **От**: ST_260 (Pool: Unisender Go)
- **К**: RT_220 (Pool: Благотворитель)

#### Task 20: Получение благодарности
- **ID**: RT_220
- **Название**: "Получение благодарственного письма"
- **Тип**: Receive Task
- **Pool**: Благотворитель
- **Lane**: 2.2
- **Входящие потоки**: MSG_210
- **Исходящие потоки**: EE_212

#### End Event 1: Успешная обработка
- **ID**: EE_210
- **Название**: "Письмо отправлено"
- **Тип**: None End Event
- **Pool**: Интеграционный сервис
- **Lane**: 5.5

#### End Event 2: Ошибка обработки
- **ID**: EE_211
- **Название**: "Ошибка отправки"
- **Тип**: Error End Event
- **Pool**: Интеграционный сервис
- **Lane**: 5.5

#### End Event 3: Благотворитель получил письмо
- **ID**: EE_212
- **Название**: "Благодарность получена"
- **Тип**: None End Event
- **Pool**: Благотворитель
- **Lane**: 2.2

---

## Процесс 3: Работа с админ-панелью (TO-BE)

### Элементы диаграммы

#### Start Event
- **ID**: SE_300
- **Название**: "Администратор открывает админ-панель"
- **Тип**: None Start Event
- **Pool**: Администратор
- **Lane**: 3.2 Работа с админ-панелью

#### Task 1: Вход в систему
- **ID**: UT_300
- **Название**: "Аутентификация"
- **Тип**: User Task
- **Pool**: Администратор
- **Lane**: 3.2
- **Входящие потоки**: SE_300
- **Исходящие потоки**: ST_300

#### Task 2: Загрузка дашборда
- **ID**: ST_300
- **Название**: "Загрузка данных дашборда"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Админ-панель (UI)
- **Lane**: 7.1 Дашборд
- **Входящие потоки**: UT_300
- **Исходящие потоки**: ST_301
- **Запросы к БД**:
  - `SELECT COUNT(*) FROM processing_logs WHERE status = 'sent' AND created_at > NOW() - INTERVAL '24 hours'`
  - `SELECT COUNT(*) FROM processing_logs WHERE status = 'failed'`
  - `SELECT COUNT(*) FROM retry_queue WHERE status = 'pending'`

#### Task 3: Запрос статистики из Unisender Go
- **ID**: ST_301
- **Название**: "API запрос статистики"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Админ-панель (UI)
- **Lane**: 7.1
- **Входящие потоки**: ST_300
- **Исходящие потоки**: UT_301
- **API**: `GET https://go1.unisender.ru/ru/transactional/api/v1/event-dump/list`
- **Обработка**: Расчет OR (Open Rate), CTR (Click-Through Rate), DR (Delivery Rate)

#### Task 4: Отображение дашборда
- **ID**: UT_301
- **Название**: "Просмотр статистики"
- **Тип**: User Task
- **Pool**: Администратор
- **Lane**: 3.3 Просмотр статистики
- **Входящие потоки**: ST_301
- **Исходящие потоки**: GW_300
- **Компоненты дашборда**:
  - Количество отправленных писем (24ч, неделя, месяц)
  - Open Rate, Click Rate, Delivery Rate
  - Количество ошибок
  - Статус очереди retry
  - Статус активных сценариев

#### Gateway: Выбор действия
- **ID**: GW_300
- **Название**: "Что делать дальше?"
- **Тип**: Event-Based Gateway
- **Pool**: Администратор
- **Lane**: 3.2
- **Входящие потоки**: UT_301
- **Исходящие потоки**: UT_310 (управление шаблонами), UT_320 (управление сценариями), UT_330 (ручная переотправка), EE_300 (выход)

---

### Подпроцесс: Управление шаблонами

#### Task 5: Переход в раздел шаблонов
- **ID**: UT_310
- **Название**: "Выбор раздела 'Шаблоны'"
- **Тип**: User Task
- **Pool**: Администратор
- **Lane**: 3.2
- **Входящие потоки**: GW_300
- **Исходящие потоки**: ST_310

#### Task 6: Загрузка списка шаблонов
- **ID**: ST_310
- **Название**: "Загрузка шаблонов из БД"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Админ-панель (UI)
- **Lane**: 7.2 Управление шаблонами
- **Входящие потоки**: UT_310
- **Исходящие потоки**: UT_311
- **SQL**: `SELECT * FROM email_templates ORDER BY name`

#### Task 7: Выбор шаблона
- **ID**: UT_311
- **Название**: "Выбор шаблона для редактирования"
- **Тип**: User Task
- **Pool**: Администратор
- **Lane**: 3.2
- **Входящие потоки**: ST_310
- **Исходящие потоки**: UT_312

#### Task 8: Редактирование текста
- **ID**: UT_312
- **Название**: "Изменение HTML/текста"
- **Тип**: User Task
- **Pool**: Администратор
- **Lane**: 3.2
- **Входящие потоки**: UT_311
- **Исходящие потоки**: ST_311
- **UI**: WYSIWYG редактор или текстовое поле

#### Task 9: Сохранение изменений
- **ID**: ST_311
- **Название**: "Обновление шаблона в БД"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Админ-панель (UI)
- **Lane**: 7.2
- **Входящие потоки**: UT_312
- **Исходящие потоки**: ST_312
- **SQL**: `UPDATE email_templates SET subject = ?, body_html = ?, body_text = ?, updated_at = NOW() WHERE id = ?`

#### Task 10: Опциональная синхронизация с Unisender Go
- **ID**: ST_312
- **Название**: "Синхронизация шаблона (опционально)"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Админ-панель (UI)
- **Lane**: 7.2
- **Входящие потоки**: ST_311
- **Исходящие потоки**: GW_300 (возврат к выбору действия)
- **API**: `PUT https://go1.unisender.ru/ru/transactional/api/v1/templates/{template_id}`

---

### Подпроцесс: Управление сценариями

#### Task 11: Переход в раздел сценариев
- **ID**: UT_320
- **Название**: "Выбор раздела 'Сценарии'"
- **Тип**: User Task
- **Pool**: Администратор
- **Lane**: 3.2
- **Входящие потоки**: GW_300
- **Исходящие потоки**: ST_320

#### Task 12: Загрузка списка сценариев
- **ID**: ST_320
- **Название**: "Загрузка конфигурации сценариев"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Админ-панель (UI)
- **Lane**: 7.3 Управление сценариями
- **Входящие потоки**: UT_320
- **Исходящие потоки**: UT_321
- **SQL**: `SELECT * FROM scenarios_config ORDER BY scenario_id`
- **Примеры записей**:
  - scenario_id: 'TP-1', name: 'Напоминание о подтверждении email', is_active: true
  - scenario_id: 'БП-1', name: 'Благодарность за пожертвование', is_active: true

#### Task 13: Выбор сценария
- **ID**: UT_321
- **Название**: "Выбор сценария для изменения"
- **Тип**: User Task
- **Pool**: Администратор
- **Lane**: 3.2
- **Входящие потоки**: ST_320
- **Исходящие потоки**: GW_310

#### Gateway: Включить/выключить?
- **ID**: GW_310
- **Название**: "Действие с сценарием"
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Администратор
- **Lane**: 3.2
- **Входящие потоки**: UT_321
- **Исходящие потоки**: ST_321 (выключить), ST_322 (включить)

#### Task 14a: Отключение сценария
- **ID**: ST_321
- **Название**: "Установка is_active = false"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Админ-панель (UI)
- **Lane**: 7.3
- **Входящие потоки**: GW_310 (выключить)
- **Исходящие потоки**: GW_311
- **SQL**: `UPDATE scenarios_config SET is_active = false, updated_at = NOW() WHERE scenario_id = ?`

#### Task 14b: Включение сценария
- **ID**: ST_322
- **Название**: "Установка is_active = true"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Админ-панель (UI)
- **Lane**: 7.3
- **Входящие потоки**: GW_310 (включить)
- **Исходящие потоки**: GW_311
- **SQL**: `UPDATE scenarios_config SET is_active = true, updated_at = NOW() WHERE scenario_id = ?`

#### Gateway: Merge
- **ID**: GW_311
- **Тип**: Exclusive Gateway (XOR - Join)
- **Pool**: Админ-панель
- **Lane**: 7.3
- **Входящие потоки**: ST_321, ST_322
- **Исходящие потоки**: GW_300 (возврат)

#### Примечание: Обработка в интеграционном сервисе
При обработке триггеров интеграционный сервис проверяет:
```python
scenario_id = determine_scenario(trigger_type)  # TP-1, БП-1, и т.д.
is_active = check_scenario_active(scenario_id)
if not is_active:
    log_skip(trigger_id, "scenario_disabled")
    return
```

---

### Подпроцесс: Ручная переотправка

#### Task 15: Переход в раздел неудачных отправок
- **ID**: UT_330
- **Название**: "Выбор раздела 'Неудачные отправки'"
- **Тип**: User Task
- **Pool**: Администратор
- **Lane**: 3.2
- **Входящие потоки**: GW_300
- **Исходящие потоки**: ST_330

#### Task 16: Загрузка failed писем
- **ID**: ST_330
- **Название**: "Загрузка писем со статусом 'failed'"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Админ-панель (UI)
- **Lane**: 7.1
- **Входящие потоки**: UT_330
- **Исходящие потоки**: UT_331
- **SQL**: `SELECT * FROM processing_logs WHERE status = 'failed' AND created_at > NOW() - INTERVAL '{days} days' ORDER BY created_at DESC LIMIT 1000`
- **Фильтры**: По дате, по типу письма, по email

#### Task 17: Просмотр и выбор писем
- **ID**: UT_331
- **Название**: "Выбор писем для переотправки"
- **Тип**: User Task
- **Pool**: Администратор
- **Lane**: 3.2
- **Входящие потоки**: ST_330
- **Исходящие потоки**: UT_332
- **UI**: Таблица с чекбоксами, детали ошибки для каждого письма

#### Task 18: Подтверждение переотправки
- **ID**: UT_332
- **Название**: "Нажатие кнопки 'Переотправить'"
- **Тип**: User Task
- **Pool**: Администратор
- **Lane**: 3.2
- **Входящие потоки**: UT_331
- **Исходящие потоки**: ST_331

#### Task 19: Формирование задач на переотправку
- **ID**: ST_331
- **Название**: "Создание задач в очереди"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Админ-панель (UI)
- **Lane**: 7.1
- **Входящие потоки**: UT_332
- **Исходящие потоки**: MSG_300
- **SQL**: `INSERT INTO retry_queue (trigger_id, retry_count, next_attempt_at, manual_resend) VALUES (?, 0, NOW(), true)`

#### Message Flow: К интеграционному сервису
- **ID**: MSG_300
- **От**: ST_331 (Pool: Админ-панель)
- **К**: ST_340 (Pool: Интеграционный сервис)

#### Task 20: Обработка задач переотправки
- **ID**: ST_340
- **Название**: "Обработка retry_queue"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.4 Retry механизм
- **Входящие потоки**: MSG_300
- **Исходящие потоки**: (стандартный процесс отправки)
- **Логика**: Аналогична обычной обработке триггера, но с флагом manual_resend

#### Task 21: Отправка через Unisender Go
- **ID**: ST_341
- **Название**: "API запрос на отправку"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.3
- **Входящие потоки**: ST_340
- **Исходящие потоки**: GW_320
- **Аналогично**: Обычному процессу отправки

#### Gateway: Результат переотправки
- **ID**: GW_320
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Интеграционный сервис
- **Lane**: 5.3
- **Входящие потоки**: ST_341
- **Исходящие потоки**: ST_342 (успех), ST_343 (ошибка)

#### Task 22a: Логирование успеха
- **ID**: ST_342
- **Название**: "Обновление статуса: sent"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.5
- **Входящие потоки**: GW_320 (успех)
- **Исходящие потоки**: MSG_301
- **SQL**: `UPDATE processing_logs SET status = 'sent', message_id = ?, manually_resent = true WHERE id = ?`

#### Task 22b: Логирование ошибки
- **ID**: ST_343
- **Название**: "Обновление статуса: failed"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Интеграционный сервис
- **Lane**: 5.5
- **Входящие потоки**: GW_320 (ошибка)
- **Исходящие потоки**: MSG_301

#### Message Flow: Результат к админ-панели
- **ID**: MSG_301
- **От**: ST_342/ST_343 (Pool: Интеграционный сервис)
- **К**: ST_344 (Pool: Админ-панель)

#### Task 23: Отображение результатов
- **ID**: ST_344
- **Название**: "Обновление UI с результатами"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Админ-панель (UI)
- **Lane**: 7.1
- **Входящие потоки**: MSG_301
- **Исходящие потоки**: UT_333

#### Task 24: Просмотр результатов
- **ID**: UT_333
- **Название**: "Просмотр результатов переотправки"
- **Тип**: User Task
- **Pool**: Администратор
- **Lane**: 3.2
- **Входящие потоки**: ST_344
- **Исходящие потоки**: GW_300 (возврат к выбору действия)
- **Отображение**: Таблица с результатами (успех/ошибка) для каждого письма

---

### Подпроцесс: Мониторинг здоровья системы

#### Timer Event: Периодическая проверка
- **ID**: TE_300
- **Название**: "Healthcheck каждые 5 минут"
- **Тип**: Timer Start Event (Cycle)
- **Pool**: Админ-панель (UI)
- **Lane**: 7.1
- **Периодичность**: `R/PT5M` (каждые 5 минут)
- **Исходящие потоки**: ST_350

#### Task 25: Healthcheck внешних API
- **ID**: ST_350
- **Название**: "Проверка доступности сервисов"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Админ-панель (UI)
- **Lane**: 7.1
- **Входящие потоки**: TE_300
- **Исходящие потоки**: GW_330
- **Проверки**:
  - `GET https://go1.unisender.ru/ru/transactional/api/v1/health` (или ping)
  - `GET https://api.cloudpayments.ru/health` (или ping)
  - Проверка доступности БД Битрикс
  - Проверка доступности БД интеграционного сервиса

#### Gateway: Все сервисы доступны?
- **ID**: GW_330
- **Название**: "Healthcheck успешен?"
- **Тип**: Exclusive Gateway (XOR)
- **Pool**: Админ-панель
- **Lane**: 7.1
- **Входящие потоки**: ST_350
- **Исходящие потоки**: ST_351 (да), ST_352 (нет)

#### Task 26a: Обновление статуса Healthy
- **ID**: ST_351
- **Название**: "Отображение зеленого индикатора"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Админ-панель (UI)
- **Lane**: 7.1
- **Входящие потоки**: GW_330 (да)
- **Исходящие потоки**: EE_310

#### Task 26b: Обновление статуса Degraded
- **ID**: ST_352
- **Название**: "Отображение красного индикатора"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Админ-панель (UI)
- **Lane**: 7.1
- **Входящие потоки**: GW_330 (нет)
- **Исходящие потоки**: ST_353

#### Task 27: Отправка alert администратору
- **ID**: ST_353
- **Название**: "Отправка уведомления о сбое"
- **Тип**: Service Task ✅ АВТОМАТИЧЕСКИ
- **Pool**: Админ-панель (UI)
- **Lane**: 7.1
- **Входящие потоки**: ST_352
- **Исходящие потоки**: EE_311
- **Каналы**: Email администратору или Telegram bot

#### End Event (Healthcheck)
- **ID**: EE_310, EE_311
- **Тип**: None End Event
- **Pool**: Админ-панель
- **Lane**: 7.1

---

## End Event (главный процесс админ-панели)
- **ID**: EE_300
- **Название**: "Выход из админ-панели"
- **Тип**: None End Event
- **Pool**: Администратор
- **Lane**: 3.2

---

## Примечания по реализации

### Технические детали

**Database Polling (TE_100)**:
- Интеграционный сервис использует Celery Beat или APScheduler
- Периодичность: 10-30 секунд
- Пакетная обработка: до 100 триггеров за раз
- После обработки: `UPDATE integration_triggers SET status = 'processed', processed_at = NOW() WHERE id IN (?)`

**Retry механизм**:
- Экспоненциальная задержка: 2^n секунд (1, 2, 4, 8)
- Максимум 3 попытки для 429/5xx
- 0 попыток для 4xx (кроме 429)
- Отдельная таблица retry_queue с scheduled_at

**Логирование**:
- Все операции логируются в processing_logs
- Уровни: sent, failed, validation_failed, duplicate_skipped
- Хранение логов: 90 дней (после - архив)

**Статистика**:
- Синхронизация с Unisender Go через webhook или polling
- События: delivered, opened, clicked, bounced, complained
- Хранение в таблице email_statistics

---

Эта детализированная спецификация готова для реализации в Camunda Modeler или других BPMN-инструментах.